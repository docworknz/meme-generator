(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,8896,2909,50766,e=>{"use strict";let t,r;function n(e){if("number"==typeof e)return(Math.abs(0x9e3779b1*e)>>>0).toString(16);if("boolean"==typeof e)return e?"1":"0";if(null===e)return"null";if(void 0===e)return"undefined";if("string"==typeof e){let t=0x811c9dc5;for(let r=0;r<e.length;r++)t^=e.charCodeAt(r),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24),t>>>=0;return t.toString(16)}if(Array.isArray(e)){let t=0x811c9dc5;for(let r=0;r<e.length;r++){t^=(r+1)*0x9e3779b1;let s=n(e[r]);for(let e=0;e<s.length;e++)t^=s.charCodeAt(e),t*=0x1000193,t>>>=0}return t.toString(16)}if("object"==typeof e){let t=0x811c9dc5,r=Object.keys(e).sort();for(let s=0;s<r.length;s++){let i=r[s];t^=parseInt(n(i),16),t*=0x1000193,t>>>=0,t^=parseInt(n(e[i]),16),t*=0x1000193,t>>>=0}return t.toString(16)}return n(String(e))}e.i(47167);let s="remove",i="replace",o=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),a=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),l=Symbol.iterator,u={mutable:"mutable",immutable:"immutable"},c={};function h(e,t){return e instanceof Map?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function d(e,t){if(t in e){let r=Reflect.getPrototypeOf(e);for(;r;){let e=Reflect.getOwnPropertyDescriptor(r,t);if(e)return e;r=Reflect.getPrototypeOf(r)}}}function f(e){return Object.getPrototypeOf(e)===Set.prototype}function p(e){return Object.getPrototypeOf(e)===Map.prototype}function y(e){var t;return null!=(t=e.copy)?t:e.original}function g(e){return!!b(e)}function b(e){return"object"!=typeof e?null:null==e?void 0:e[o]}function m(e){var t;let r=b(e);return r?null!=(t=r.copy)?t:r.original:e}function v(e,t){let r;return!!e&&"object"==typeof e&&(Object.getPrototypeOf(e)===Object.prototype||Array.isArray(e)||e instanceof Map||e instanceof Set||!!(null==t?void 0:t.mark)&&((r=t.mark(e,u))===u.immutable||"function"==typeof r))}function _(e){return Array.isArray(e)?1:e instanceof Map?2:3*(e instanceof Set)}function w(e,t){return 2===_(e)?e.get(t):e[t]}function S(e,t,r){2===_(e)?e.set(t,r):e[t]=r}function T(e,t){let r=b(e);return(r?y(r):e)[t]}function k(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function O(e){if(e)for(;e.finalities.revoke.length>0;)e.finalities.revoke.pop()()}function E(e,t){return t?e:[""].concat(e).map(e=>{let t=`${e}`;return -1===t.indexOf("/")&&-1===t.indexOf("~")?t:t.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}let A=Object.prototype.propertyIsEnumerable;function I(e,t){let r;if(Array.isArray(e))return Array.prototype.concat.call(e);if(e instanceof Set)return f(e)?Set.prototype.difference?Set.prototype.difference.call(e,new Set):new Set(e.values()):new(Object.getPrototypeOf(e)).constructor(e.values());if(e instanceof Map)return p(e)?new Map(e):new(Object.getPrototypeOf(e)).constructor(e);if((null==t?void 0:t.mark)&&void 0!==(r=t.mark(e,u))&&r!==u.mutable){if(r===u.immutable){let t;return t=Object.create(Object.getPrototypeOf(e)),Reflect.ownKeys(e).forEach(r=>{let n=Reflect.getOwnPropertyDescriptor(e,r);if(n.enumerable&&n.configurable&&n.writable){t[r]=e[r];return}n.writable||(n.writable=!0,n.configurable=!0),(n.get||n.set)&&(n={configurable:!0,writable:!0,enumerable:n.enumerable,value:e[r]}),Reflect.defineProperty(t,r,n)}),t}if("function"==typeof r){if(t.enablePatches||t.enableAutoFreeze)throw Error("You can't use mark and patches or auto freeze together.");return r()}throw Error(`Unsupported mark result: ${r}`)}if("object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype){let t={};return Object.keys(e).forEach(r=>{t[r]=e[r]}),Object.getOwnPropertySymbols(e).forEach(r=>{A.call(e,r)&&(t[r]=e[r])}),t}else throw Error("Please check mark() to ensure that it is a stable marker draftable function.")}function C(e){e.copy||(e.copy=I(e.original,e.options))}function M(e){return g(e)?function e(t){if(!v(t))return m(t);if(Array.isArray(t))return t.map(e);if(t instanceof Map){let r=Array.from(t.entries()).map(([t,r])=>[t,e(r)]);return p(t)?new Map(r):new(Object.getPrototypeOf(t)).constructor(r)}if(t instanceof Set){let r=Array.from(t).map(e);return f(t)?new Set(r):new(Object.getPrototypeOf(t)).constructor(r)}let r=Object.create(Object.getPrototypeOf(t));for(let n in t)r[n]=e(t[n]);return r}(e):e}function x(e){var t;e.assignedMap=null!=(t=e.assignedMap)?t:new Map,!e.operated&&(e.operated=!0,e.parent&&x(e.parent))}function P(){throw Error("Cannot modify frozen object")}function j(e,t){let r=_(e);if(0===r)Reflect.ownKeys(e).forEach(r=>{t(r,e[r],e)});else if(1===r){let r=0;for(let n of e)t(r,n,e),r+=1}else e.forEach((r,n)=>t(n,r,e))}function $(e){3===e.type&&e.copy&&(e.copy.clear(),e.setMap.forEach(t=>{e.copy.add(m(t))}))}function D(e,t,r,n){if(e.operated&&e.assignedMap&&e.assignedMap.size>0&&!e.finalized){if(r&&n){let s=function e(t,r=[]){if(Object.hasOwnProperty.call(t,"key")){let e=t.parent.copy,n=b(w(e,t.key));if(null!==n&&(null==n?void 0:n.original)!==t.original)return null;let s=3===t.parent.type,i=s?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(s&&e.size>i||h(e,i)))return null;r.push(i)}if(t.parent)return e(t.parent,r);r.reverse();try{var n=t.copy,s=r;for(let e=0;e<s.length-1;e+=1){let t=s[e];if("object"!=typeof(n=w(3===_(n)?Array.from(n):n,t)))throw Error(`Cannot resolve patch at '${s.join("/")}'.`)}}catch(e){return null}return r}(e);s&&t(e,s,r,n)}e.finalized=!0}}function U(e,t,r,n){let s=b(r);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((i,o)=>{var a;let l=3===e.type?e.setMap:e.copy;if(k(w(l,t),r)){let r=s.original;s.copy&&(r=s.copy),$(e),D(e,n,i,o),e.options.enableAutoFreeze&&(e.options.updatedValues=null!=(a=e.options.updatedValues)?a:new WeakMap,e.options.updatedValues.set(r,s.original)),S(l,t,r)}}),e.options.enableAutoFreeze&&s.finalities!==e.finalities&&(e.options.enableAutoFreeze=!1)),v(r,e.options)&&e.finalities.draft.push(()=>{let n;k(w(3===e.type?e.setMap:e.copy,t),r)&&(n=3===e.type?e.setMap:e.copy,e.finalities.revoke.length>1&&e.assignedMap.get(t)&&n&&function e(t,r,n){if(g(t)||!v(t,n)||r.has(t)||Object.isFrozen(t))return;let s=t instanceof Set,i=s?new Map:void 0;if(r.add(t),j(t,(o,a)=>{var l;if(g(a)){let e=b(a);C(e),S(s?i:t,o,(null==(l=e.assignedMap)?void 0:l.size)||e.operated?e.copy:e.original)}else e(a,r,n)}),i){let e=Array.from(t);t.clear(),e.forEach(e=>{t.add(i.has(e)?i.get(e):e)})}}(w(n,t),e.finalities.handledSet,e.options))})}function R(e,t,r,n){let{pathAsArray:o=!0}=e.options.enablePatches;switch(e.type){case 0:case 2:return function({original:e,copy:t,assignedMap:r},n,o,a,l){r.forEach((r,u)=>{let c=w(e,u),d=M(w(t,u)),f=r?h(e,u)?i:"add":s;if(k(c,d)&&f===i)return;let p=E(n.concat(u),l);o.push(f===s?{op:f,path:p}:{op:f,path:p,value:d}),a.push("add"===f?{op:s,path:p}:f===s?{op:"add",path:p,value:c}:{op:i,path:p,value:c})})}(e,t,r,n,o);case 1:return function(e,t,r,n,o){let{original:a,assignedMap:l,options:u}=e,c=e.copy;c.length<a.length&&([a,c]=[c,a],[r,n]=[n,r]);for(let e=0;e<a.length;e+=1)if(l.get(e.toString())&&c[e]!==a[e]){let s=E(t.concat([e]),o);r.push({op:i,path:s,value:M(c[e])}),n.push({op:i,path:s,value:M(a[e])})}for(let e=a.length;e<c.length;e+=1){let n=E(t.concat([e]),o);r.push({op:"add",path:n,value:M(c[e])})}if(a.length<c.length){let{arrayLengthAssignment:e=!0}=u.enablePatches;if(e){let e=E(t.concat(["length"]),o);n.push({op:i,path:e,value:a.length})}else for(let e=c.length;a.length<e;e-=1){let r=E(t.concat([e-1]),o);n.push({op:s,path:r})}}}(e,t,r,n,o);case 3:return function({original:e,copy:t},r,n,i,o){let a=0;e.forEach(e=>{if(!t.has(e)){let t=E(r.concat([a]),o);n.push({op:s,path:t,value:e}),i.unshift({op:"add",path:t,value:e})}a+=1}),a=0,t.forEach(t=>{if(!e.has(t)){let e=E(r.concat([a]),o);n.push({op:"add",path:e,value:t}),i.unshift({op:s,path:e,value:t})}a+=1})}(e,t,r,n,o)}}let N=(e,t,r=!1)=>{if("object"==typeof e&&null!==e&&(!v(e,t)||r)&&1)throw Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},L={get size(){return y(b(this)).size},has(e){return y(b(this)).has(e)},set(e,t){let r=b(this),n=y(r);return n.has(e)&&k(n.get(e),t)||(C(r),x(r),r.assignedMap.set(e,!0),r.copy.set(e,t),U(r,e,t,R)),this},delete(e){if(!this.has(e))return!1;let t=b(this);return C(t),x(t),t.original.has(e)?t.assignedMap.set(e,!1):t.assignedMap.delete(e),t.copy.delete(e),!0},clear(){let e=b(this);if(this.size){for(let[t]of(C(e),x(e),e.assignedMap=new Map,e.original))e.assignedMap.set(t,!1);e.copy.clear()}},forEach(e,t){y(b(this)).forEach((r,n)=>{e.call(t,this.get(n),n,this)})},get(e){var t,r;let n=b(this),s=y(n).get(e),i=(null==(r=(t=n.options).mark)?void 0:r.call(t,s,u))===u.mutable;if(n.options.strict&&N(s,n.options,i),i||n.finalized||!v(s,n.options)||s!==n.original.get(e))return s;let o=c.createDraft({original:s,parentDraft:n,key:e,finalities:n.finalities,options:n.options});return C(n),n.copy.set(e,o),o},keys(){return y(b(this)).keys()},values(){let e=this.keys();return{[l]:()=>this.values(),next:()=>{let t=e.next();return t.done?t:{done:!1,value:this.get(t.value)}}}},entries(){let e=this.keys();return{[l]:()=>this.entries(),next:()=>{let t=e.next();if(t.done)return t;let r=this.get(t.value);return{done:!1,value:[t.value,r]}}}},[l](){return this.entries()}},F=Reflect.ownKeys(L),K=(e,t,{isValuesIterator:r})=>()=>{var n,s;let i=t.next();if(i.done)return i;let o=i.value,a=e.setMap.get(o),l=b(a),h=(null==(s=(n=e.options).mark)?void 0:s.call(n,a,u))===u.mutable;if(e.options.strict&&N(o,e.options,h),!h&&!l&&v(o,e.options)&&!e.finalized&&e.original.has(o)){let t=c.createDraft({original:o,parentDraft:e,key:o,finalities:e.finalities,options:e.options});e.setMap.set(o,t),a=t}else l&&(a=l.proxy);return{done:!1,value:r?a:[a,a]}},q={get size(){return b(this).setMap.size},has(e){let t=b(this);if(t.setMap.has(e))return!0;C(t);let r=b(e);return!!(r&&t.setMap.has(r.original))},add(e){let t=b(this);return this.has(e)||(C(t),x(t),t.assignedMap.set(e,!0),t.setMap.set(e,e),U(t,e,e,R)),this},delete(e){if(!this.has(e))return!1;let t=b(this);C(t),x(t);let r=b(e);return r&&t.setMap.has(r.original)?(t.assignedMap.set(r.original,!1),t.setMap.delete(r.original)):(!r&&t.setMap.has(e)?t.assignedMap.set(e,!1):t.assignedMap.delete(e),t.setMap.delete(e))},clear(){if(!this.size)return;let e=b(this);for(let t of(C(e),x(e),e.original))e.assignedMap.set(t,!1);e.setMap.clear()},values(){let e=b(this);C(e);let t=e.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:K(e,t,{isValuesIterator:!0})}},entries(){let e=b(this);C(e);let t=e.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:K(e,t,{isValuesIterator:!1})}},keys(){return this.values()},[l](){return this.values()},forEach(e,t){let r=this.values(),n=r.next();for(;!n.done;)e.call(t,n.value,n.value,this),n=r.next()}};Set.prototype.difference&&Object.assign(q,{intersection(e){return Set.prototype.intersection.call(new Set(this.values()),e)},union(e){return Set.prototype.union.call(new Set(this.values()),e)},difference(e){return Set.prototype.difference.call(new Set(this.values()),e)},symmetricDifference(e){return Set.prototype.symmetricDifference.call(new Set(this.values()),e)},isSubsetOf(e){return Set.prototype.isSubsetOf.call(new Set(this.values()),e)},isSupersetOf(e){return Set.prototype.isSupersetOf.call(new Set(this.values()),e)},isDisjointFrom(e){return Set.prototype.isDisjointFrom.call(new Set(this.values()),e)}});let W=Reflect.ownKeys(q),z={get(e,t,r){var n,s;let i,a=null==(n=e.copy)?void 0:n[t];if(a&&e.finalities.draftsCache.has(a))return a;if(t===o)return e;if(e.options.mark){let n="size"===t&&(e.original instanceof Map||e.original instanceof Set)?Reflect.get(e.original,t):Reflect.get(e.original,t,r);if((i=e.options.mark(n,u))===u.mutable)return e.options.strict&&N(n,e.options,!0),n}let l=y(e);if(l instanceof Map&&F.includes(t))return"size"===t?Object.getOwnPropertyDescriptor(L,"size").get.call(e.proxy):L[t].bind(e.proxy);if(l instanceof Set&&W.includes(t))return"size"===t?Object.getOwnPropertyDescriptor(q,"size").get.call(e.proxy):q[t].bind(e.proxy);if(!h(l,t)){let r=d(l,t);return r?"value"in r?r.value:null==(s=r.get)?void 0:s.call(e.proxy):void 0}let c=l[t];if(e.options.strict&&N(c,e.options),e.finalized||!v(c,e.options))return c;if(c===T(e.original,t)){if(C(e),e.copy[t]=V({original:e.original[t],parentDraft:e,key:1===e.type?Number(t):t,finalities:e.finalities,options:e.options}),"function"==typeof i){let r=b(e.copy[t]);return C(r),x(r),r.copy}return e.copy[t]}return g(c)&&e.finalities.draftsCache.add(c),c},set(e,t,r){var n;let s;if(3===e.type||2===e.type)throw Error("Map/Set draft does not support any property assignment.");if(1===e.type&&"length"!==t&&!(Number.isInteger(s=Number(t))&&s>=0&&(0===t||0===s||String(s)===String(t))))throw Error("Only supports setting array indices and the 'length' property.");let i=d(y(e),t);if(null==i?void 0:i.set)return i.set.call(e.proxy,r),!0;let o=T(y(e),t),a=b(o);return a&&k(a.original,r)?(e.copy[t]=r,e.assignedMap=null!=(n=e.assignedMap)?n:new Map,e.assignedMap.set(t,!1),!0):!!(k(r,o)&&(void 0!==r||h(e.original,t)))||(C(e),x(e),h(e.original,t)&&k(r,e.original[t])?e.assignedMap.delete(t):e.assignedMap.set(t,!0),e.copy[t]=r,U(e,t,r,R),!0)},has:(e,t)=>t in y(e),ownKeys:e=>Reflect.ownKeys(y(e)),getOwnPropertyDescriptor(e,t){let r=y(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n?{writable:!0,configurable:1!==e.type||"length"!==t,enumerable:n.enumerable,value:r[t]}:n},getPrototypeOf:e=>Reflect.getPrototypeOf(e.original),setPrototypeOf(){throw Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(e,t){var r;return 1===e.type?z.set.call(this,e,t,void 0,e.proxy):(void 0!==T(e.original,t)||t in e.original?(C(e),x(e),e.assignedMap.set(t,!1)):(e.assignedMap=null!=(r=e.assignedMap)?r:new Map,e.assignedMap.delete(t)),e.copy&&delete e.copy[t],!0)}};function V(e){let{original:t,parentDraft:r,key:n,finalities:s,options:i}=e,o=_(t),a={type:o,finalized:!1,parent:r,original:t,copy:null,proxy:null,finalities:s,options:i,setMap:3===o?new Map(t.entries()):void 0};(n||"key"in e)&&(a.key=n);let{proxy:l,revoke:u}=Proxy.revocable(1===o?Object.assign([],a):a,z);if(s.revoke.push(u),a.proxy=l,r)r.finalities.draft.push((e,t)=>{var s,i;let o=b(l),a=3===r.type?r.setMap:r.copy,u=w(a,n),c=b(u);if(c){let i=c.original;c.operated&&(i=m(u)),$(c),D(c,R,e,t),r.options.enableAutoFreeze&&(r.options.updatedValues=null!=(s=r.options.updatedValues)?s:new WeakMap,r.options.updatedValues.set(i,c.original)),S(a,n,i)}null==(i=o.callbacks)||i.forEach(r=>{r(e,t)})});else{let e=b(l);e.finalities.draft.push((t,r)=>{$(e),D(e,R,t,r)})}return l}function Q(e){let{rootDraft:t,value:r,useRawReturn:n=!1,isRoot:s=!0}=e;j(r,(r,n,s)=>{let i=b(n);if(i&&t&&i.finalities===t.finalities){e.isContainDraft=!0;let t=i.original;if(s instanceof Set){let e=Array.from(s);s.clear(),e.forEach(e=>s.add(r===e?t:e))}else S(s,r,t)}else"object"==typeof n&&null!==n&&(e.value=n,e.isRoot=!1,Q(e))}),s&&(e.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),n&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function G(e){if(!g(e))throw Error(`current() is only used for Draft, parameter: ${e}`);return function e(t){var r;let n,s=b(t);if(!v(t,null==s?void 0:s.options))return t;let i=_(t);if(s&&!s.operated)return s.original;function o(){n=2===i?p(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):3===i?Array.from(s.setMap.values()):I(t,null==s?void 0:s.options)}if(s){s.finalized=!0;try{o()}finally{s.finalized=!1}}else n=t;if(j(n,(r,i)=>{if(s&&k(w(s.original,r),i))return;let a=e(i);a!==i&&(n===t&&o(),S(n,r,a))}),3===i){let e=null!=(r=null==s?void 0:s.original)?r:n;return f(e)?new Set(n):new(Object.getPrototypeOf(e)).constructor(n)}return n}(e)}c.createDraft=V;let B=function e(t,r,n){var s,o,l,c;let h,d,f,p,y;if("function"==typeof t&&"function"!=typeof r)return function(n,...s){return e(n,e=>t.call(this,e,...s),r)};let m=n;if("function"!=typeof r&&(m=r),void 0!==m&&"[object Object]"!==Object.prototype.toString.call(m))throw Error(`Invalid options: ${m}, 'options' should be an object.`);m=Object.assign(Object.assign({},void 0),m);let w=g(t)?G(t):t,S=Array.isArray(m.mark)?(e,t)=>{for(let r of m.mark){if("function"!=typeof r)throw Error(`Invalid mark: ${r}, 'mark' should be a function.`);let n=r(e,t);if(n)return n}}:m.mark,T=null!=(s=m.enablePatches)&&s,E=null!=(o=m.strict)&&o,A={enableAutoFreeze:null!=(l=m.enableAutoFreeze)&&l,mark:S,strict:E,enablePatches:T};if(!v(w,A)&&"object"==typeof w&&null!==w)throw Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");let[I,C]=(p={draft:[],revoke:[],handledSet:new WeakSet,draftsCache:new WeakSet},A.enablePatches&&(d=[],f=[]),[y=(null==(c=A.mark)?void 0:c.call(A,w,u))!==u.mutable&&v(w,A)?V({original:w,parentDraft:null,finalities:p,options:A}):w,(e=[])=>{let[t,r,n]=function(e,t,r,n,s){var o;let a=b(e),l=null!=(o=null==a?void 0:a.original)?o:e,u=!!t.length;if(null==a?void 0:a.operated)for(;a.finalities.draft.length>0;)a.finalities.draft.pop()(r,n);let c=u?t[0]:a?a.operated?a.copy:a.original:e;return a&&O(a),s&&function e(t,r,n,s,i){{n=null!=n?n:new WeakMap,s=null!=s?s:[],i=null!=i?i:[];let e=n.has(t)?n.get(t):t;if(s.length>0){let t=s.indexOf(e);if(e&&"object"==typeof e&&-1!==t){if(s[0]===e)throw Error("Forbids circular reference");throw Error(`Forbids circular reference: ~/${i.slice(0,t).map((e,t)=>{if("symbol"==typeof e)return`[${e.toString()}]`;let r=s[t];return"object"==typeof e&&(r instanceof Map||r instanceof Set)?Array.from(r.keys()).indexOf(e):e}).join("/")}`)}s.push(e),i.push(r)}else s.push(e)}if(Object.isFrozen(t)||g(t)){s.pop(),i.pop();return}switch(_(t)){case 2:for(let[r,o]of t)e(r,r,n,s,i),e(o,r,n,s,i);t.set=t.clear=t.delete=P;break;case 3:for(let r of t)e(r,r,n,s,i);t.add=t.clear=t.delete=P;break;case 1:Object.freeze(t);let o=0;for(let r of t)e(r,o,n,s,i),o+=1;break;default:Object.freeze(t),Object.keys(t).forEach(r=>{e(t[r],r,n,s,i)})}s.pop(),i.pop()}(c,c,null==a?void 0:a.options.updatedValues),[c,r&&u?[{op:i,path:[],value:t[0]}]:r,n&&u?[{op:i,path:[],value:l}]:n]}(y,e,d,f,A.enableAutoFreeze);return A.enablePatches?[t,r,n]:t}]);if("function"!=typeof r){if(!v(w,A))throw Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[I,C]}try{h=r(I)}catch(e){throw O(b(I)),e}let M=e=>{let t=b(I);if(!g(e)){if(void 0!==e&&!k(e,I)&&(null==t?void 0:t.operated))throw Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");let r=null==e?void 0:e[a];if(r){let n=r[0];return A.strict&&"object"==typeof e&&null!==e&&Q({rootDraft:t,value:e,useRawReturn:!0}),C([n])}if(void 0!==e)return"object"==typeof e&&null!==e&&Q({rootDraft:t,value:e}),C([e])}if(e===I||void 0===e)return C([]);let r=b(e);if(A===r.options){if(r.operated)throw Error("Cannot return a modified child draft.");return C([G(e)])}return C([e])};return h instanceof Promise?h.then(M,e=>{throw O(b(I)),e}):M(h)};function J(e,t){let r=Object.keys(e),n=Object.keys(t);return r.length===n.length&&Object.keys(e).every(e=>t.hasOwnProperty(e))}function H(e,t){return Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(r=>t.hasOwnProperty(r)&&e[r]===t[r])}function Z(e,t){return"object"!=typeof e||"object"!=typeof t||null===e||null===t?e===t:!!J(e,t)&&Object.keys(e).every(r=>Z(e[r],t[r]))}function Y(e){if(!X(e))return e;let t={};for(let[r,n]of Object.entries(e))void 0!==n&&(t[r]=n);return t}function X(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function ee(e,t,r){if(!e||0===t.length)return;let n=e||{};for(let e=0;e<t.length-1;e++){let r=t[e];r in n&&"object"==typeof n[r]||(n[r]="number"==typeof t[e+1]?[]:{}),n=n[r]}n[t[t.length-1]]=r}Object.prototype.constructor.toString();let et=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,er={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800},en=/^(\d+)[\./-](\d+)[\./-](\d+)$/,es=[function(e){let t=e.match(en);if(!t)return null;let[r,n,s,i]=t;return n<=0||s<=0||i<=0?null:new Date(n>999?Date.UTC(n,s-1,i,0,0,0,0):Date.UTC(i,n-1,s,0,0,0,0))},function(e){let[t,r]=e.split(" ");return new Date(t+"T"+r+"Z")},function(e){if(!e.match(/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/))throw Error(`Unable to parse \`${e}\` as a date.`);let t=new Date(e+" UTC");return new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),0,0,0,0))},function(e){let[t,r]=e.split(", "),[n,s,i]=t.split("/").map(Number),o=r.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!o)throw Error(`Unable to parse time from: ${e}`);let[,a,l,u,c]=o;return a=Number(a),l=Number(l),u=Number(u),"PM"===c&&12!==a?a+=12:"AM"===c&&12===a&&(a=0),new Date(Date.UTC(i,n-1,s,a,l,u))},function(e){return new Date(e)},function(e){return new Date(e+"Z")},function(e){let t=e.match(/^(.+T.+)([+-])(\d{2})$/);if(t){let[,e,r,n]=t;return new Date(`${e}${r}${n}:00`)}return null},function(e){let[t,r]=e.split(" ");return new Date(t+"T"+r+"Z")},function(e){return new Date(e)},function(e){switch(e){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}},function(e){let t=e.match(et);if(!t)return null;let[r]=t,n=er[r];return new Date(new Date(e.replace(et,"Z")).getTime()-1e3*n)},function(e){let t=e.match(/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/);if(t){let[,e,r,n,s,i]=t,o=r.padStart(2,"0"),a=n.padStart(2,"0");return new Date(`${e}-${o}-${a}T${i}`)}return null}];function ei(e){for(let t of es){let r=function(e,t){try{let r=e(t);if(r instanceof Date&&!isNaN(r.getTime()))return r;return null}catch(e){return null}}(t,e);if(r)return r}return null}function eo(e){if(void 0!==e){if(null===e)return null;if(e instanceof Date)return e;if("string"==typeof e){let t=ei(e)||function(e){try{let t=JSON.parse(e);if("string"==typeof t)return ei(t);return null}catch(e){return null}}(e)||ei(e.trim());if(!t)throw Error(`Unable to parse \`${e}\` as a date.`);return t}if("number"==typeof e)return new Date(e);throw Error(`Invalid date value \`${e}\`. Expected a date, number, or string, got type ${typeof e}.`)}}class ea{attrs;linkIndex;_blobAttrs=null;_primaryKeys=null;_forwardIdents=null;_revIdents=null;constructor(e,t){this.attrs=e,this.linkIndex=t}resetAttrIndexes(){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null}addAttr(e){this.attrs[e.id]=e,this.resetAttrIndexes()}deleteAttr(e){delete this.attrs[e],this.resetAttrIndexes()}updateAttr(e){let t=this.attrs[e.id];t&&(this.attrs[e.id]={...t,...e},this.resetAttrIndexes())}getAttr(e){return this.attrs[e]}get blobAttrs(){if(this._blobAttrs)return this._blobAttrs;for(let e of(this._blobAttrs=new Map,Object.values(this.attrs)))if(eu(e)){let[t,r,n]=e["forward-identity"];ed(this.blobAttrs,[r,n],e)}return this._blobAttrs}get primaryKeys(){if(this._primaryKeys)return this._primaryKeys;for(let e of(this._primaryKeys=new Map,Object.values(this.attrs)))if(e["primary?"]){let[t,r]=e["forward-identity"];ed(this._primaryKeys,[r],e)}return this._primaryKeys}get forwardIdents(){if(this._forwardIdents)return this._forwardIdents;for(let e of(this._forwardIdents=new Map,Object.values(this.attrs))){let[t,r,n]=e["forward-identity"];ed(this._forwardIdents,[r,n],e)}return this._forwardIdents}get revIdents(){if(this._revIdents)return this._revIdents;for(let e of(this._revIdents=new Map,Object.values(this.attrs))){let t=e["reverse-identity"];if(t){let[r,n,s]=t;ed(this._revIdents,[n,s],e)}}return this._revIdents}toJSON(){return{attrs:this.attrs,linkIndex:this.linkIndex}}}function el(e){return"ref"===e["value-type"]}function eu(e){return"blob"===e["value-type"]}function ec(e,t){return t.reduce((e,t)=>e&&e.get(t),e)}function eh(e,t){if(0===t.length)throw Error("path must have at least one element");if(1===t.length)return void e.delete(t[0]);let[r,...n]=t;e.has(r)&&eh(e.get(r),n)}function ed(e,t,r){let n=e,s=t.length-1;for(let e=0;e<s;e++){let r=t[e],s=n.get(r);void 0===s&&(s=new Map,n.set(r,s)),n=s}s>-1&&n.set(t[s],r)}function ef(e,t,r){let n=new Map,s=new Map,i=new Map;for(let o of t){let[t,a,l]=o,u=e.getAttr(a);if(!u){console.warn("no such attr",a,t);continue}"date"===u["checked-data-type"]&&r&&(l=eo(l),o[2]=l),el(u)&&ed(i,[l,a,t],o),ed(n,[t,a,l],o),ed(s,[a,t,l],o)}return{eav:n,aev:s,vae:i}}function ep(e){return{triples:ek(e.eav,3),cardinalityInference:e.cardinalityInference,useDateObjects:e.useDateObjects,version:1}}function ey(e,t){return eb(e,t.triples,t.cardinalityInference,t.useDateObjects)}function eg(e,t){return e?new ea(e.attrs,e.linkIndex):t&&"__type"in t?new ea(t.attrs,t.linkIndex):void 0}function eb(e,t,r,n){let s=ef(e,t,n);return s.cardinalityInference=r,s.useDateObjects=n,s}function em(e,t){let r;if(Array.isArray(t[0])){let[n,s]=t[0],i=e.aev.get(n);if(!i)return null;let o=ek(i,2);r=o.find(e=>e[2]===s)?.[0]}else r=t[0];if(!r)return null;let n=t[2];if(Array.isArray(n)&&2===n.length&&e.aev.get(n[0])){let[s,i]=n,o=e.aev.get(s);if(!o)return null;let a=ek(o,2),l=a.find(e=>e[2]===i)?.[0];if(!l)return null;let[u,c,h,...d]=t;return[r,c,l,...d]}{let[e,...n]=t;return[r,...n]}}function ev(e,t,r){let n=em(e,r);if(!n)return;let[s,i,o]=n,a=t.getAttr(i);a&&(eh(e.eav,[s,i,o]),eh(e.aev,[i,s,o]),el(a)&&eh(e.vae,[o,i,s]))}let e_=0;function ew(e,t,r){let n,[s,i,o]=r,a=ec(e.eav,[s,i,o]);return a&&(n=a[3]),n||10*Date.now()+e_++}function eS(e,t,r){let n=em(e,r);if(!n)return;let[s,i,o]=n,a=t.getAttr(i);if(!a)return;"date"===a["checked-data-type"]&&e.useDateObjects&&(o=eo(o));let l=ec(e.eav,[s,i,o]),u=[s,i,o,l?.[3]??ew(e,a,n)];"one"===a.cardinality?(ed(e.eav,[s,i],new Map([[o,u]])),ed(e.aev,[i,s],new Map([[o,u]]))):(ed(e.eav,[s,i,o],u),ed(e.aev,[i,s,o],u)),el(a)&&ed(e.vae,[o,i,s],u)}function eT(e,t,r){let n=ef(t,r,e.useDateObjects);Object.keys(n).forEach(t=>{e[t]=n[t]})}function ek(e,t,r=[]){if(!e||0===t)return r;if(1===t){for(let t of e.values())r.push(t);return r}for(let n of e.values())ek(n,t-1,r);return r}function eO(e,t,r){let n=[];if(r?.hasOwnProperty("$not")){for(let e of t.keys())r.$not!==e&&n.push(t.get(e));return n}if(r?.hasOwnProperty("$isNull")){let{attrId:s,isNull:i,reverse:o}=r.$isNull;if(o)for(let r of t.keys()){let o=e.vae.get(r),a=!o||!o.get(s);(i?a:!a)&&n.push(t.get(r))}else{let r=e.aev.get(s);for(let e of t.keys()){let s=!r||r.get(e)?.get(null)||!r.get(e);(i?s:!s)&&n.push(t.get(e))}}return n}if(r?.$comparator)return ek(t,1).filter(r.$op);for(let e of r.in||r.$in||[r]){let r=t.get(e);r&&n.push(r)}return n}function eE(e,t,r){return e.forwardIdents.get(t)?.get(r)}function eA(e,t,r){return e.revIdents.get(t)?.get(r)}function eI(e,t){let r=e.primaryKeys.get(t);return r||e.forwardIdents.get(t)?.get("id")}function eC(e,t,r){return e===t?r:null}let eM=["in","$in","$not","$isNull","$comparator"];function ex(e,t,r){return r?"object"==typeof e?!function(e){for(let t of eM)if(e.hasOwnProperty(t))return!0;return!1}(e)?null:r:("string"==typeof e&&e.startsWith("?")?function(e,t,r){return r.hasOwnProperty(e)?ex(r[e],t,r):{...r,[e]:t}}:eC)(e,t,r):null}function eP(e,t){return Array.isArray(t)?t.map(t=>eP(e,t)):"string"==typeof t&&t.startsWith("?")?e[t]:t}let ej="u">typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),e$=new Uint8Array(16),eD=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,eU=function(e){return"string"==typeof e&&eD.test(e)},eR=[];for(let e=0;e<256;++e)eR.push((e+256).toString(16).slice(1));let eN=function(e,r,n){if(ej&&!r&&!e)return ej();let s=(e=e||{}).random??e.rng?.()??function(){if(!t){if("u"<typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");t=crypto.getRandomValues.bind(crypto)}return t(e$)}();if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,r){if((n=n||0)<0||n+16>r.length)throw RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[n+e]=s[e];return r}return function(e,t=0){return(eR[e[t+0]]+eR[e[t+1]]+eR[e[t+2]]+eR[e[t+3]]+"-"+eR[e[t+4]]+eR[e[t+5]]+"-"+eR[e[t+6]]+eR[e[t+7]]+"-"+eR[e[t+8]]+eR[e[t+9]]+"-"+eR[e[t+10]]+eR[e[t+11]]+eR[e[t+12]]+eR[e[t+13]]+eR[e[t+14]]+eR[e[t+15]]).toLowerCase()}(s)};function eL(e){let t=e.replace(/-/g,""),r=[];for(let e=0;e<t.length;e+=2)r.push(parseInt(t.substring(e,e+2),16));return r}let eF=function(){return eN()};function eK(e,t){return e.localeCompare(t)}let eq=function(){let e=eK;if("object"==typeof Intl&&Intl.hasOwnProperty("Collator"))try{e=Intl.Collator("en-US").compare}catch(e){}return e}(),eW=0;function ez(e){return eV(`_${e}`,eW++)}function eV(e,t){return`?${e}-${t}`}class eQ extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function eG(e,t,r,n){return[e(r,n),function(e,t){let r=eI(e,t);if(!r)throw new eQ(`Could not find id attr for ${t}`);return r}(t,r).id,e(r,n),e("time",n)]}function eB(e,t,r,n,s){let i=eE(t,r,s),o=eA(t,r,s),a=i||o;if(!a)throw new eQ(`Could not find attr for ${[r,s]}`);if("ref"!==a["value-type"])throw Error(`Attr ${a.id} is not a ref`);let[l,u]=a["forward-identity"],[c,h]=a["reverse-identity"],d=n+1,f=i?[e(u,n),a.id,e(h,d),ez("time")]:[e(u,d),a.id,e(h,n),ez("time")];return[i?h:u,d,f,a,!!i]}function eJ(e,t){if("string"!=typeof t)return function(e){return!1};let r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),n=RegExp(`^${r}$`,e?void 0:"i");return function(e){return"string"==typeof e&&n.test(e)}}function eH(e,t,r,n,s,i){let o=s.slice(0,s.length-1),a=s[s.length-1],[l,u,c]=function(e,t,r,n,s){let[i,o,a]=s.reduce((r,n)=>{let[s,i,o]=r,[a,l,u]=eB(e,t,s,i,n);return[a,l,[...o,u]]},[r,n,[]]);return[i,o,a]}(e,t,r,n,o),h=function(e,t,r,n,s,i){let o=eE(t,r,s),a=eA(t,r,s),l=o||a;if(!l)throw new eQ(`No attr for etype = ${r} label = ${s}`);if(i?.hasOwnProperty("$isNull")){let s=eE(t,r,"id");if(!s)throw new eQ(`No attr for etype = ${r} label = id`);return[e(r,n),s.id,{$isNull:{attrId:l.id,isNull:i.$isNull,reverse:!o}},ez("time")]}return o?[e(r,n),l.id,function(e,t){if("object"!=typeof t||t.hasOwnProperty("$in")||t.hasOwnProperty("in"))return t;let r="date"===e["checked-data-type"];if(t.hasOwnProperty("$gt"))return{$comparator:!0,$op:r?function(e){return new Date(e[2])>new Date(t.$gt)}:function(e){return e[2]>t.$gt}};if(t.hasOwnProperty("$gte"))return{$comparator:!0,$op:r?function(e){return new Date(e[2])>=new Date(t.$gte)}:function(e){return e[2]>=t.$gte}};if(t.hasOwnProperty("$lt"))return{$comparator:!0,$op:r?function(e){return new Date(e[2])<new Date(t.$lt)}:function(e){return e[2]<t.$lt}};if(t.hasOwnProperty("$lte"))return{$comparator:!0,$op:r?function(e){return new Date(e[2])<=new Date(t.$lte)}:function(e){return e[2]<=t.$lte}};if(t.hasOwnProperty("$like")){let e=eJ(!0,t.$like);return{$comparator:!0,$op:function(t){return e(t[2])}}}if(t.hasOwnProperty("$ilike")){let e=eJ(!1,t.$ilike);return{$comparator:!0,$op:function(t){return e(t[2])}}}return t}(l,i),ez("time")]:[i,l.id,e(r,n),ez("time")]}(e,t,l,u,a,i);return c.concat([h])}function eZ(e,t,r,n,s,i){let o=e(n,s);return{[t]:{patterns:i.map((t,i)=>eX((t,r)=>{let n=e(t,r);return o==n?n:`${n}-${i}`},r,n,s,t)),joinSym:o}}}function eY(e,t,r,n,s){return(function(e){let t=[];for(let r=1;r<=e.length;r++)t.push(e.slice(0,r));return t})(s).map(s=>eH(e,t,r,n,s,{$isNull:!0}))}function eX(e,t,r,n,s){return Object.entries(s).flatMap(([s,i])=>{if(function([e,t]){return"or"===e&&Array.isArray(t)}([s,i]))return eZ(e,"or",t,r,n,i);if(function([e,t]){return"and"===e&&Array.isArray(t)}([s,i]))return eZ(e,"and",t,r,n,i);if("$entityIdStartsWith"===s)return[];let o=s.split(".");return(i?.hasOwnProperty("$ne")&&(i={...i,$not:i.$ne},delete i.$ne),i?.hasOwnProperty("$not"))?[{or:{patterns:[eH(e,t,r,n,o,i),...eY(e,t,r,n,o)],joinSym:e(r,n)}}]:i?.hasOwnProperty("$isNull")&&!0===i.$isNull&&o.length>1?[{or:{patterns:eY(e,t,r,n,o),joinSym:e(r,n)}}]:eH(e,t,r,n,o,i)})}function e0(e,t,r,n,s){return t===n||null==t&&null==n?function(e,t){for(let r=0;r<e.length;r++){if(e[r]<t[r])return -1;if(e[r]>t[r])return 1}return 0}(eL(e),eL(r)):null==n?1:null==t?-1:"string"===s?eq(t,n):t>n?1:-1}function e1([e,t],[r,n],s){return e0(e,t,r,n,s)}function e2(e){return null==e?e:new Date(e).getTime()}function e3(e){let t=e.$?.offset,r=e.$?.before,n=e.$?.after;return!t&&!r&&!n}function e4({store:e,attrsStore:t,pageInfo:r,aggregate:n},s){let i={data:Object.keys(s).reduce(function(i,o){return n?.[o]||"$$ruleParams"===o||(i[o]=function e(t,r,n){let s=function(e,t,r){try{return function(e,t,{etype:r,level:n,form:s,join:i,pageInfo:o}){var a,l,u,c,h,d;if(!e3(s)&&(!o||!o["start-cursor"]))return[];let f=(u=t,c=r,h=n,a=(d=s.$?.where)?eX(eV,u,c,h,d).concat([eG(eV,u,c,h)]):[eG(eV,u,c,h)],i?[i].concat(a):a),p=[(l=eV)(r,n),l("time",n)],y=s.$?.fields,g=function(e,t,{etype:r,pageInfo:n,dq:s,form:i}){var o;let a,l=i?.$?.order,u=e3(i),c=(o=i,(a=o.$?.order)&&a[Object.keys(a)[0]]||"asc"),h=function(e,{find:t,where:r}){return(function e(t,r,n=[{}]){return r.reduce((r,n)=>n.or?n.or.patterns.flatMap(n=>e(t,n,r)):n.and?n.and.patterns.reduce((r,n)=>e(t,n,r),r):r.flatMap(e=>(function(e,[t,r,n]){let s;switch(s="",void 0!==t&&(s+="e"),void 0!==r&&(s+="a"),void 0!==n&&(s+="v"),s){case"e":return ek(e.eav.get(t),2);case"ea":return ek(e.eav.get(t)?.get(r),1);case"eav":{let s=e.eav.get(t)?.get(r);if(!s)return[];return eO(e,s,n)}case"ev":{let r=e.eav.get(t);if(!r)return[];let s=[];for(let t of r.values())s.push(...eO(e,t,n));return s}case"a":return ek(e.aev.get(r),2);case"av":{let t=e.aev.get(r);if(!t)return[];let s=[];for(let r of t.values())s.push(...eO(e,r,n));return s}case"v":{let t=[];for(let r of e.eav.values())for(let s of r.values())t.push(...eO(e,s,n));return t}default:return ek(e.eav,3)}})(t,eP(e,n)).map(t=>n.reduce((e,r,n)=>ex(r,t[n],e),e)).filter(e=>e)),n)})(e,r).map(e=>eP(e,t))}(e,s),d=n?.["start-cursor"],f=function(e,t,r,n){if(r){let t;return t=r[1],e.getAttr(t)}if(n)return eE(e,t,Object.keys(n)[0])}(t,r,d,l);if(f&&f?.["forward-identity"]?.[2]!=="id"){let t="date"===f["checked-data-type"],r=f.id;h=h.map(([n])=>{let s=e.eav.get(n)?.get(r)?.values()?.next()?.value?.[2];return t&&(s=e2(s)),[n,s]})}h.sort("asc"===c?function(e,t){return e1(e,t,f?.["checked-data-type"])}:function(e,t){return e1(t,e,f?.["checked-data-type"])});let p={},y=function(e,t,r){if(!Array.isArray(r.fields))return e.blobAttrs.get(t);let n=new Map;for(let s of r.fields){let r=eE(e,t,s),i=r?.["forward-identity"]?.[2];i&&eu(r)&&n.set(i,r)}if(!n.has("id")){let r=eE(e,t,"id"),s=r?.["forward-identity"]?.[2];s&&n.set(s,r)}return n}(t,r,s);for(let t of h){let[r]=t;if(p[r]||!u&&d&&f&&function(e,t,r,n){let[s,i,o,a]=e,l="desc"===r?1:-1;if(t["forward-identity"]?.[2]==="id")return e1(n,[s,a],null)===l;let[u,c]=n,h=t["checked-data-type"],d="date"===h?e2(c):c;return e1([u,d],[s,"date"===h?e2(o):o],h)===l}(d,f,c,t))continue;let n=function(e,t,r){let n={};if(!t)return n;for(let[s,i]of t.entries())for(let t of ek(e.eav.get(r)?.get(i.id),1))n[s]=t[2];return n}(e,y,r);n&&(p[r]=n)}return p}(e,t,{etype:r,pageInfo:o,form:s,dq:{where:f,find:p,fields:y}}),b=s.$?.limit||s.$?.first||s.$?.last;if(null!=b){n>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");let e=Object.entries(g);return e.length<=b?g:Object.fromEntries(e.slice(0,b))}return g}(e,t,r)}catch(e){if(e instanceof eQ)return{};throw e}}(t,r,n);return function(t,r,n,{etype:s,level:i,form:o},a){let l=Object.keys(o).filter(e=>"$"!==e);return l.length?Object.entries(a).map(function([a,u]){return l.map(function(l){let u=!!(r.cardinalityInference&&n.linkIndex?.[s]?.[l]?.isSingular);try{let[c,h,d]=function(e,t,r,n,s,i){var o;let[a,l,u,c,h]=eB(e,t,r,n,s);return[a,l,(o=e(r,n),u.map(e=>e===o?i:e)),c,h]}(t,n,s,i,l,a),f=e(r,n,{etype:c,level:h,form:o[l],join:d}),p=u?f[0]:f;return{[l]:p}}catch(e){if(e instanceof eQ)return{[l]:u?void 0:[]};throw e}}).reduce(function(e,t){return{...e,...t}},u)}):Object.values(a)}(eV,t,r,n,s)}(e,t,{etype:o,form:s[o],level:0,pageInfo:r?.[o]})),i},{})};return r&&(i.pageInfo=function(e){let t={};for(let[r,n]of Object.entries(e))t[r]={startCursor:n["start-cursor"],endCursor:n["end-cursor"],hasNextPage:n["has-next-page?"],hasPreviousPage:n["has-previous-page?"]};return t}(r)),n&&(i.aggregate=n),i}let e6=new Set(["__etype","__ops","create","update","link","unlink","delete","merge","ruleParams"]);function e8(e,t,r){return new Proxy({__etype:e,__ops:r},{get:(n,s)=>"__ops"===s?r:"__etype"===s?e:e6.has(s)?(n,i)=>e8(e,t,[...r,i?[s,e,t,n,i]:[s,e,t,n]]):void 0})}function e9(e){return e.startsWith("lookup__")}function e5(e){let[t,r,...n]=e.split("__");return[r,JSON.parse(n.join("__"))]}function e7(){return new Proxy({},{get:(e,t)=>new Proxy({__etype:t},{get:(e,r)=>"lookup"===r?(e,r)=>e8(t,e5(`lookup__${e}__${JSON.stringify(r)}`),[]):"__etype"===r?t:e9(r)?e8(t,e5(r),[]):e8(t,r,[])})})}function te(e){let[t,r,...n]=e.split(".");if(n.length>0||"id"!==r)throw Error(`${e} is not a valid lookup attribute.`);return t}function tt(e){return"string"!=typeof e||e9(e)?"string"==typeof e&&e9(e)?e5(e):function(e){if(Array.isArray(e))return e;let t=Object.entries(e);if(1!==t.length)throw Error("lookup must be an object with a single unique attr and value.");return t[0]}(e):null}function tr(e,t,r){let n=tt(r);if(null===n)return r;let[s,i]=n,o=function(e,t,r){if(-1===r.indexOf(".")||eE(e,t,r))return eE(e,t,r);let n=te(r),s=eE(e,t,n)||eA(e,t,n);if(s&&"ref"!==s["value-type"])throw Error(`${r} does not reference a valid link attribute.`);return s}(e,t,s);if(!o||!o["unique?"])throw Error(`${s} is not a unique attribute.`);return[o.id,i]}function tn(e,t,r,n){let s=tr(e,t,r);return Array.isArray(s)?[["add-triple",s,eE(e,t,"id")?.id,s]].concat(n):n}function ts({stores:e,attrsStore:t},[r,n,s,i]){return i?.upsert===!1?{mode:"update"}:i?.upsert===!0||!function(e,t,r,n){if(Array.isArray(n)){let[t,r]=n;for(let n of e||[]){let e=n?.aev.get(t);if(e){for(let[t,n,s]of ek(e,2))if(s===r)return!0}}}else for(let s of e||[]){let e=s?.eav.get(n);if(e){for(let n of e.keys())if(t.getAttr(n)?.["forward-identity"][1]==r)return!0}}return!1}(e,t,r,n)?null:{mode:"update"}}function ti(e,t,r,n){let s=e?function(e,t,r){let n=e.entities[t]?.attrs?.[r];if("id"===r)return null;if(!n)throw Error(`${t}.${r} does not exist in your schema`);let{unique:s,indexed:i}=n?.config;return{"index?":i,"unique?":s,"checked-data-type":function(e){switch(e){case"string":case"date":case"boolean":case"number":return e;default:return}}(n?.valueType)}}(e,t,r):null;return{id:eF(),"forward-identity":[eF(),t,r],"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...n||{}}}function to(e,t,r,n){let s=e?function(e,t,r){let n=Object.values(e.links).find(e=>e.forward.on===t&&e.forward.label===r||e.reverse.on===t&&e.reverse.label===r);if(!n)throw Error(`Couldn't find the link ${t}.${r} in your schema`);let{forward:s,reverse:i}=n;return{"forward-identity":[eF(),s.on,s.label],"reverse-identity":[eF(),i.on,i.label],cardinality:"one"===s.has?"one":"many","unique?":"one"===i.has,"on-delete":s.onDelete,"on-delete-reverse":i.onDelete}}(e,t,r):null;return{id:eF(),"forward-identity":[eF(),t,r],"reverse-identity":[eF(),r,t],"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...n||{}}}e7();let ta=new Set(["create","update","merge","link","unlink"]),tl=new Set(["link","unlink"]),tu=new Set(["create","update","merge"]),tc=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),th={"unique?":!0,"index?":!0},td={...th,cardinality:"one"};function tf(e,t){"u"<typeof requestIdleCallback?e():requestIdleCallback(e,{timeout:t})}let tp="__meta";class ty{constructor(e,t){}}class tg{currentValue;_subs=[];_persister;_merge;serialize;parse;_saveThrottleMs;_idleCallbackMaxWaitMs;_nextSave=null;_nextGc=null;_pendingSaveKeys=new Set;_loadedKeys=new Set;_loadingKeys;_objectSize;_log;onKeyLoaded;_version=0;_meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0};_gcOpts;constructor(e){this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=e.saveThrottleMs??100,this._idleCallbackMaxWaitMs=e.idleCallbackMaxWaitMs??1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}async _initMeta(){this._meta.loadingPromise&&await this._meta.loadingPromise;try{let e=this._persister.getItem(tp);this._meta.loadingPromise=e;let t=await e;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;let r=this._meta.value?.objects??{},n=t??{},s=n.objects??{};this._meta.value={...n,objects:{...r,...s}}}catch(e){this._meta.error=e,this._meta.attempts++,this._meta.loadingPromise=null}}async _getMeta(){return this._meta.value||(this._meta.loadingPromise||this._initMeta(),await this._meta.loadingPromise),this._meta.value}async _refreshMeta(){return await this._initMeta(),this._meta.value}async _preloadEntries(e){let t=await this.waitForMetaToLoad();if(!t)return;let r=Object.entries(t.objects);for(let[t]of(r.sort(([e,t],[r,n])=>n.updatedAt-t.updatedAt),r.slice(0,e)))this._loadKey(t)}async _getFromStorage(e){try{let t=await this._persister.getItem(e);if(!t)return t;return this.parse(e,t)}catch(t){return console.error(`Unable to read from storage for key=${e}`,t),null}}async waitForKeyToLoad(e){return this._loadedKeys.has(e)||await (this._loadingKeys[e]||this._loadKey(e)),this.currentValue[e]}async waitForMetaToLoad(){return this._getMeta()}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}async _loadKey(e){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;let t=this._getFromStorage(e);this._loadingKeys[e]=t;let r=await t;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){let t=this._merge(e,r,this.currentValue[e]);t&&(this.currentValue[e]=t)}this.onKeyLoaded&&this.onKeyLoaded(e)}_writeToStorage(e){let t=[],r=e?.skipGc;if(this._meta.isLoading){let r=new Promise((t,r)=>{setTimeout(()=>this._enqueuePersist(e?{...e,attempts:(e.attempts||0)+1}:{attempts:1}).then(t).catch(r),10+(e?.attempts??0)*1e3)});return t.push(r),Promise.all(t).then(e=>e.reduce((e,t)=>e+t,0))}let n=this._meta.value;if(!n)return Promise.resolve(0);let s=[],i=[];for(let e of this._pendingSaveKeys)e in this.currentValue?i.push(e):(s.push(e),delete n.objects[e]);for(let e of s){let r=this._persister.removeItem(e);t.push(r.then(()=>1)),this._loadedKeys.delete(e),this._pendingSaveKeys.delete(e)}let o=[],a=[[tp,n]],l=n.objects??{};for(let e of(n.objects=l,i))if(this._loadedKeys.has(e)){let t=this.serialize(e,this.currentValue[e]);a.push([e,t]);let r=this._objectSize(t),n=l[e]??{createdAt:Date.now(),updatedAt:Date.now(),size:r};n.updatedAt=Date.now(),n.size=r,l[e]=n,this._pendingSaveKeys.delete(e)}else o.push(e);let u=this._persister.multiSet(a);for(let r of(t.push(u.then(()=>1)),o)){let n=this._loadKey(r).then(()=>this._enqueuePersist(e));t.push(n)}return r||this.gc(),Promise.all(t).then(e=>e.reduce((e,t)=>e+t,0))}async flush(){if(this._nextSave)return clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()}async _gc(){if(!this._gcOpts)return;let e=new Set(await this._persister.getAllKeys());e.delete(tp);let t=new Set(Object.keys(this.currentValue));for(let e of Object.keys(this._loadingKeys))t.add(e);for(let e of this._loadedKeys)t.add(e);let r=await this._refreshMeta();if(!r)return void this._log.info("Could not gc because we were not able to load meta");let n=[],s={gcOpts:this._gcOpts,keys:e,sacredKeys:t,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(let i of e)t.has(i)||i in r.objects||(this._log.info("Lost track of key in meta",i),n.push(this._persister.removeItem(i)),s.removed.push(i),s.removedMissingCount++);let i=Date.now();for(let[e,o]of Object.entries(r.objects))!t.has(e)&&o.updatedAt<i-this._gcOpts.maxAgeMs&&(n.push(this._persister.removeItem(e)),delete r.objects[e],s.removed.push(e),s.removedOldCount++);let o=Object.entries(r.objects);o.sort(([e,t],[r,n])=>t.updatedAt-n.updatedAt);let a=o.filter(([e])=>!t.has(e));if(o.length>this._gcOpts.maxEntries)for(let[e]of a.slice(0,o.length-this._gcOpts.maxEntries))n.push(this._persister.removeItem(e)),delete r.objects[e],s.removed.push(e),s.removedThresholdCount++;let l=Object.entries(r.objects);l.sort(([e,t],[r,n])=>t.updatedAt-n.updatedAt);let u=l.filter(([e])=>!t.has(e)),c=l.reduce((e,[t,r])=>e+r.size,0);for(;c>0&&c>this._gcOpts.maxSize&&u.length;){let[[e,t]]=u.splice(0,1);c-=t.size,n.push(this._persister.removeItem(e)),delete r.objects[e],s.removed.push(e),s.removedSizeCount++}for(let n of Object.keys(r.objects))e.has(n)||t.has(n)||delete r.objects[n];return(s.removed.length||s.metaRemoved.length)&&n.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",s),await Promise.all(n),s}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{tf(()=>{this._nextGc=null,this._gc()},3e4)},6e4+500*Math.random()))}_enqueuePersist(e){return new Promise((t,r)=>{this._nextSave?t(0):this._nextSave=setTimeout(()=>{tf(()=>{this._nextSave=null,this._writeToStorage(e).then(t).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;let[t,r]=B(this.currentValue,e,{enablePatches:!0});for(let e of r){let t=e.path[0];t&&"string"==typeof t&&(this._pendingSaveKeys.add(t),this._loadedKeys.has(t)||this._loadKey(t))}for(let e of(this.currentValue=t,this._enqueuePersist(),this._subs))e(this.currentValue);return t}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(t=>t!==e)}}}let tb=["kv","querySubs","syncSubs"];function tm(e){return function(t){console.error("Error in IndexedDB event",{source:e,event:t})}}async function tv(e){return new Promise(t=>{let r=indexedDB.open(e);r.onerror=e=>{t(null)},r.onsuccess=e=>{t(e.target.result)},r.onupgradeneeded=e=>{let r=e.target;r.transaction?.abort(),t(null)}})}async function t_(e,t,r){let n="string"==typeof t?JSON.parse(t):t;if(!n)return;let s=new Set;return new Promise((t,i)=>{let o={};for(let[e,t]of Object.entries(n)){let n="string"==typeof t?JSON.parse(t):t;if(n.lastAccessed){let t={createdAt:n.lastAccessed,updatedAt:n.lastAccessed,size:n.result?.store?.triples?.length??0};o[e]=t}let i=r.put(n,e);s.add(i)}let a=r.put({objects:o},tp);for(let r of(s.add(a),s))r.onsuccess=()=>{s.delete(r),0===s.size&&t()},r.onerror=t=>{tm(`Move ${e} to querySubs store failed`),i(t)}})}async function tw(e,t,r){let n=r.put(t,e);return new Promise((e,t)=>{n.onsuccess=()=>e(),n.onerror=e=>t(e)})}async function tS(e,t){let r=await tv(`instant_${e}_5`);if(!r)return;let n=await new Promise((e,t)=>{let n=r.transaction(["kv"],"readonly").objectStore("kv").openCursor();n.onerror=e=>{t(e)};let s=[];n.onsuccess=()=>{let t=n.result;if(t){let e=t.key,r=t.value;s.push([e,r]),t.continue()}else e(s)},n.onerror=e=>{t(e)}}),s=t.transaction(["kv","querySubs"],"readwrite"),i=s.objectStore("kv"),o=s.objectStore("querySubs"),a=[],l={objects:{}};for(let[e,t]of n)if("querySubs"===e){let r=t_(e,t,o);a.push(r)}else{let r=tw(e,t,i);a.push(r);let n={createdAt:Date.now(),updatedAt:Date.now(),size:0};l.objects[e]=n}let u=tw(tp,l,i);a.push(u),await Promise.all(a),await new Promise((e,t)=>{s.oncomplete=t=>e(t),s.onerror=e=>t(e),s.onabort=e=>t(e)})}let tT=new Map;class tk extends ty{dbName;_storeName;_appId;_prefix;_dbPromise;constructor(e,t){super(e,t),this.dbName=`instant_${e}_6`,this._storeName=t,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,t)=>{let r=!1,n=indexedDB.open(this.dbName,1);n.onerror=e=>{t(e)},n.onsuccess=t=>{let n=t.target.result;if(r){let t=tS(this._appId,n).catch(e=>{tm("Error upgrading store from version 5 to 6.")(e)});tT.set(this.dbName,t),t.then(()=>e(n)).catch(()=>e(n))}else{let t=tT.get(this.dbName);t?t.then(()=>e(n)).catch(()=>e(n)):e(n)}},n.onupgradeneeded=e=>{r=!0,this._upgradeStore(e)}})}_upgradeStore(e){let t=e.target.result;for(let e of tb)t.objectStoreNames.contains(e)||t.createObjectStore(e)}async getItem(e){let t=await this._dbPromise;return new Promise((r,n)=>{let s=t.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);s.onerror=e=>{n(e)},s.onsuccess=e=>{s.result?r(s.result):r(null)}})}async setItem(e,t){let r=await this._dbPromise;return new Promise((n,s)=>{let i=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(t,e);i.onerror=e=>{s(e)},i.onsuccess=e=>{n()}})}async multiSet(e){let t=await this._dbPromise;return new Promise((r,n)=>{let s=t.transaction([this._storeName],"readwrite"),i=s.objectStore(this._storeName),o=new Set;for(let[t,r]of e){let e=i.put(r,t);o.add(e)}for(let e of o)e.onerror=e=>{s.abort(),n(e)},e.onsuccess=t=>{o.delete(e),0===o.size&&r()}})}async removeItem(e){let t=await this._dbPromise;return new Promise((r,n)=>{let s=t.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);s.onerror=e=>{n(e)},s.onsuccess=e=>{r()}})}async getAllKeys(){let e=await this._dbPromise;return new Promise((t,r)=>{let n=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();n.onerror=e=>{r(e)},n.onsuccess=e=>{t(n.result.filter(e=>"string"==typeof e))}})}}class tO{static async getIsOnline(){return navigator.onLine}static listen(e){let t=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",t),addEventListener("offline",r),()=>{removeEventListener("online",t),removeEventListener("offline",r)}}}class tE extends Error{hint;constructor(e,t){super(e),this.hint=t;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,tE),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}class tA extends tE{body;status;constructor(e){super(e.body?.message||`API Error (${e.status})`,e.body.hint);const t=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,t),Error.captureStackTrace&&Error.captureStackTrace(this,tA),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}async function tI(e,t){let r=await fetch(e,t),n=await r.json();return 200===r.status?Promise.resolve(n):Promise.reject(new tA({status:r.status,body:n}))}async function tC({apiURI:e,appId:t,email:r,code:n,refreshToken:s}){return await tI(`${e}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":t,email:r,code:n,...s?{"refresh-token":s}:{}})})}async function tM({apiURI:e,appId:t,refreshToken:r}){return await tI(`${e}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":t,"refresh-token":r})})}async function tx({apiURI:e,appId:t}){return await tI(`${e}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":t})})}async function tP({apiURI:e,appId:t,code:r,codeVerifier:n,refreshToken:s}){return await tI(`${e}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t,code:r,code_verifier:n,refresh_token:s})})}async function tj({apiURI:e,appId:t,nonce:r,idToken:n,clientName:s,refreshToken:i}){return await tI(`${e}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t,nonce:r,id_token:n,client_name:s,refresh_token:i})})}async function t$({apiURI:e,appId:t,refreshToken:r}){return await tI(`${e}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t,refresh_token:r})})}async function tD({apiURI:e,appId:t,path:r,file:n,refreshToken:s,contentType:i,contentDisposition:o}){let a={app_id:t,path:r,authorization:`Bearer ${s}`,"content-type":i||n.type};return o&&(a["content-disposition"]=o),await tI(`${e}/storage/upload`,{method:"PUT",headers:a,body:n})}async function tU({apiURI:e,appId:t,path:r,refreshToken:n}){let{data:s}=await tI(`${e}/storage/files?app_id=${t}&filename=${encodeURIComponent(r)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${n}`}});return s}async function tR({apiURI:e,appId:t,fileName:r,refreshToken:n,metadata:s={}}){let{data:i}=await tI(`${e}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${n}`},body:JSON.stringify({app_id:t,filename:r})});return i}async function tN(e,t){return(await fetch(e,{method:"PUT",body:t,headers:{"Content-Type":t.type}})).ok}async function tL({apiURI:e,appId:t,path:r,refreshToken:n}){let{data:s}=await tI(`${e}/storage/signed-download-url?app_id=${t}&filename=${encodeURIComponent(r)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${n}`}});return s}let tF=!1,tK=!1,tq=!1;function tW(e,t){if(!t)return e;let r={};return t.forEach(t=>{r[t]=e[t]}),r}"u">typeof window&&void 0!==window.localStorage&&(tF=!!window.localStorage.getItem("devBackend"),tK=!!window.localStorage.getItem("__instantLogging"),tq=!!window.localStorage.getItem("__devtoolLocalDash"));class tz{promise;_resolve;_reject;constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function tV(e){let t=[];return!function e(t,r=[]){t.forEach(t=>{let{data:n}=t,{"datalog-result":s}=n,{"join-rows":i}=s;for(let e of i)for(let t of e)r.push(t);e(t["child-nodes"],r)})}(e,t),t}function tQ(e){return Object.values(e.links).reduce((e,t)=>(e[t.forward.on]??={},e[t.forward.on][t.forward.label]={isForward:!0,isSingular:"one"===t.forward.has,link:t},e[t.reverse.on]??={},e[t.reverse.on][t.reverse.label]={isForward:!1,isSingular:"one"===t.reverse.has,link:t},e),{})}let tG="v0.22.142";class tB{valueType;required;isIndexed;config;metadata={};constructor(e,t,r,n={indexed:!1,unique:!1}){this.valueType=e,this.required=t,this.isIndexed=r,this.config=n}clientRequired(){return new tB(this.valueType,!1,this.isIndexed,this.config)}optional(){return new tB(this.valueType,!1,this.isIndexed,this.config)}unique(){return new tB(this.valueType,this.required,this.isIndexed,{...this.config,unique:!0})}indexed(){return new tB(this.valueType,this.required,!0,{...this.config,indexed:!0})}}class tJ{attrs;links;constructor(e,t){this.attrs=e,this.links=t}asType(){return new tJ(this.attrs,this.links)}}class tH{entities;links;rooms;constructor(e,t,r){this.entities=e,this.links=t,this.rooms=r}withRoomSchema(){return new tH(this.entities,this.links,{})}}class tZ extends Error{constructor(e,t){super(t?`At path '${t}': ${e}`:e),this.name="QueryValidationError"}}let tY=["where","order","limit","last","first","offset","after","before","fields","aggregate"],tX=(e,t,r=!1)=>{if(r||null==e)return!0;switch(t){case"string":return"string"==typeof e;case"number":return"number"==typeof e&&!isNaN(e);case"boolean":return"boolean"==typeof e;case"date":return e instanceof Date||"string"==typeof e||"number"==typeof e;default:return!0}},t0=(e,t,r,n,s,i,o)=>{let a="json"===i.valueType,l=(e,t,r)=>{if(!tX(r,t,a))throw new tZ(`Invalid value for operator '${e}' on attribute '${n}' in entity '${s}'. Expected ${t}, but received: ${typeof r}`,o)};switch(e){case"in":case"$in":if(!Array.isArray(t))throw new tZ(`Operator '${e}' for attribute '${n}' in entity '${s}' must be an array, but received: ${typeof t}`,o);for(let n of t)l(e,r,n);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":l(e,r,t);break;case"$like":case"$ilike":if(l(e,"string",t),"$ilike"===e&&!i.isIndexed)throw new tZ(`Operator '${e}' can only be used with indexed attributes, but '${n}' in entity '${s}' is not indexed`,o);break;case"$isNull":l(e,"boolean",t);break;default:throw new tZ(`Unknown operator '${e}' for attribute '${n}' in entity '${s}'`,o)}},t1=(e,t,r,n,s)=>{let i=r.valueType||"unknown",o="json"===r.valueType;if("object"!=typeof e||null===e||Array.isArray(e)){if(!tX(e,i,o))throw new tZ(`Invalid value for attribute '${t}' in entity '${n}'. Expected ${i}, but received: ${typeof e}`,s)}else{if(o)return;for(let[o,a]of Object.entries(e))t0(o,a,i,t,n,r,`${s}.${o}`)}},t2=(e,t,r,n,s)=>{let i=e.split(".");if(i.length<2)throw new tZ(`Invalid dot notation path '${e}'. Must contain at least one dot.`,s);let o=r;for(let t=0;t<i.length-1;t++){let r=i[t],a=n.entities[o];if(!a)throw new tZ(`Entity '${o}' does not exist in schema while traversing dot notation path '${e}'.`,s);let l=a.links[r];if(!l){let t=Object.keys(a.links);throw new tZ(`Link '${r}' does not exist on entity '${o}' in dot notation path '${e}'. Available links: ${t.length>0?t.join(", "):"none"}`,s)}o=l.entityName}let a=i[i.length-1],l=n.entities[o];if(!l)throw new tZ(`Target entity '${o}' does not exist in schema for dot notation path '${e}'.`,s);if("id"===a){if("string"==typeof t&&!eU(t))throw new tZ(`Invalid value for id field in entity '${o}'. Expected a UUID, but received: ${t}`,s);t1(t,e,new tB("string",!1,!0),r,s);return}let u=l.attrs[a];if(Object.keys(l.links).includes(a)){if("string"==typeof t&&!eU(t))throw new tZ(`Invalid value for link '${a}' in entity '${o}'. Expected a UUID, but received: ${t}`,s);t1(t,e,new tB("string",!1,!0),r,s);return}if(!u){let t=Object.keys(l.attrs);throw new tZ(`Attribute '${a}' does not exist on entity '${o}' in dot notation path '${e}'. Available attributes: ${t.length>0?t.join(", ")+", id":"id"}`,s)}t1(t,e,u,r,s)},t3=(e,t,r,n)=>{for(let[s,i]of Object.entries(e)){if("or"===s||"and"===s){if(Array.isArray(i))for(let e of i)"object"==typeof e&&null!==e&&t3(e,t,r,`${n}.${s}[${e}]`);continue}if("id"===s){t1(i,"id",new tB("string",!1,!0),t,`${n}.id`);continue}if(s.includes(".")){t2(s,i,t,r,`${n}.${s}`);continue}let e=r.entities[t];if(!e)continue;let o=e.attrs[s],a=e.links[s];if(!o&&!a){let r=Object.keys(e.attrs),i=Object.keys(e.links);throw new tZ(`Attribute or link '${s}' does not exist on entity '${t}'. Available attributes: ${r.length>0?r.join(", "):"none"}. Available links: ${i.length>0?i.join(", "):"none"}`,`${n}.${s}`)}if(o)t1(i,s,o,t,`${n}.${s}`);else if(a){if("string"==typeof i&&!eU(i))throw new tZ(`Invalid value for link '${s}' in entity '${t}'. Expected a UUID, but received: ${i}`,`${n}.${s}`);t1(i,s,new tB("string",!1,!0),t,`${n}.${s}`)}}},t4=(e,t,r,n,s=0)=>{for(let t of Object.keys(e))if(!tY.includes(t))throw new tZ(`Invalid query parameter '${t}' in $ object. Valid parameters are: ${tY.join(", ")}. Found: ${t}`,n);for(let t of["offset","before","after","first","last"])if(void 0!==e[t]&&s>0)throw new tZ(`'${t}' can only be used on top-level namespaces. It cannot be used in nested queries.`,n);if(e.where&&r){if("object"!=typeof e.where||null===e.where)throw new tZ(`'where' clause must be an object in entity '${t}', but received: ${typeof e.where}`,n?`${n}.where`:void 0);t3(e.where,t,r,n?`${n}.where`:"where")}},t6=(e,t,r,n,s=0)=>{if(!e||"object"!=typeof e)throw new tZ(`Query part for entity '${t}' must be an object, but received: ${typeof e}`,n);for(let i of Object.keys(e))if("$"!==i){if(r&&!(i in r.entities[t].links)){let e=Object.keys(r.entities[t].links);throw new tZ(`Link '${i}' does not exist on entity '${t}'. Available links: ${e.length>0?e.join(", "):"none"}`,`${n}.${i}`)}let o=e[i];if("object"==typeof o&&null!==o){let e=r?.entities[t].links[i]?.entityName;e&&t6(o,e,r,`${n}.${i}`,s+1)}}else{let o=e[i];if("object"!=typeof o||null===o)throw new tZ(`Query parameter '$' must be an object in entity '${t}', but received: ${typeof o}`,`${n}.$`);t4(o,t,r,`${n}.$`,s)}},t8=(e,t)=>{if("object"!=typeof e||null===e)throw new tZ(`Query must be an object, but received: ${typeof e}${null===e?" (null)":""}`);if(Array.isArray(e))throw new tZ(`Query must be an object, but received: ${typeof e}`);for(let r of Object.keys(e)){if(Array.isArray(e[r])||"string"!=typeof r)throw new tZ(`Query keys must be strings, but found key of type: ${typeof r}`,r);if("$$ruleParams"!==r){if(t&&!t.entities[r]){let e=Object.keys(t.entities);throw new tZ(`Entity '${r}' does not exist in schema. Available entities: ${e.length>0?e.join(", "):"none"}`,r)}t6(e[r],r,t,r,0)}}},t9=e=>"string"==typeof e&&(!!e9(e)||eU(e));class t5 extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}let t7=e=>e.length>0?e.join(", "):"none",re={string:e=>"string"==typeof e,number:e=>"number"==typeof e&&!isNaN(e),boolean:e=>"boolean"==typeof e,date:e=>e instanceof Date||"string"==typeof e||"number"==typeof e,json:()=>!0},rt=(e,t)=>null==e||(re[t.valueType]?.(e)??!1),rr=(e,t)=>{let r=t.entities[e];if(!r){let r;throw r=Object.keys(t.entities),new t5(`Entity '${e}' does not exist in schema. Available entities: ${t7(r)}`)}return r},rn=(e,t,r)=>{let n=rr(e,r);if("object"!=typeof t||null===t)throw new t5(`Arguments for data operation on entity '${e}' must be an object, but received: ${typeof t}`);for(let[r,s]of Object.entries(t)){if("id"===r)continue;let t=n.attrs[r];if(t&&!rt(s,t))throw new t5(`Invalid value for attribute '${r}' in entity '${e}'. Expected ${t.valueType}, but received: ${typeof s}`)}},rs=(e,t,r)=>{let n=rr(e,r);if("object"!=typeof t||null===t)throw new t5(`Arguments for link operation on entity '${e}' must be an object, but received: ${typeof t}`);for(let[r,s]of Object.entries(t)){if(!n.links[r]){let t=Object.keys(n.links);throw new t5(`Link '${r}' does not exist on entity '${e}'. Available links: ${t7(t)}`)}if(null!=s){if(Array.isArray(s)){for(let t of s)if(!t9(t))throw new t5(`Invalid entity ID in link '${r}' for entity '${e}'. Expected a UUID or a lookup, but received: ${t}`)}else if(!t9(s))throw new t5(`Invalid UUID in link '${r}' for entity '${e}'. Expected a UUID, but received: ${s}`)}}},ri={create:rn,update:rn,merge:rn,link:rs,unlink:rs,delete:()=>{}},ro=(e,t)=>{if(!t)return;let[r,n,s,i]=e;if(!Array.isArray(s)&&!eU(s))throw new t5(`Invalid id for entity '${n}'. Expected a UUID, but received: ${s}`);if("string"!=typeof n)throw new t5(`Entity name must be a string, but received: ${typeof n}`);let o=ri[r];o&&void 0!==i&&o(n,i,t)},ra=0;class rl{type="ws";conn;id;onopen;onmessage;onclose;onerror;constructor(e){this.id=`${this.type}_${ra++}`,this.conn=new WebSocket(e),this.conn.onopen=e=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=e=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(e.data.toString())})},this.conn.onclose=e=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=e=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){return this.conn.readyState===(WebSocket.OPEN??1)}isConnecting(){return this.conn.readyState===(WebSocket.CONNECTING??0)}send(e){return this.conn.send(JSON.stringify(e))}}class ru{type="sse";initParams=null;sendQueue=[];sendPromise;closeFired=!1;sseInitTimeout=void 0;ES;messageUrl;conn;url;id;onopen;onmessage;onclose;onerror;constructor(e,t,r){this.id=`${this.type}_${ra++}`,this.url=t,this.messageUrl=r||this.url,this.ES=e,this.conn=new e(t),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=e=>{let t=JSON.parse(e.data);if(Array.isArray(t))for(let e of t)this.handleMessage(e);else this.handleMessage(t)},this.conn.onerror=e=>{this.handleError()}}handleMessage(e){if("sse-init"===e.op){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}async postMessages(e){try{(await fetch(this.messageUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:this.initParams?.machineId,session_id:this.initParams?.sessionId,sse_token:this.initParams?.sseToken,messages:e})})).ok||this.handleError()}catch(e){this.handleError()}}async flushQueue(){if(this.sendPromise||!this.sendQueue.length)return;let e=this.sendQueue;this.sendQueue=[];let t=this.postMessages(e);this.sendPromise=t,t.then(()=>{this.sendPromise=null,this.flushQueue()})}send(e){if(!this.isOpen()||!this.initParams){if(this.isConnecting())throw Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state.");if(this.conn.readyState===this.ES.CLOSED)throw Error("EventSource is already in CLOSING or CLOSED state.");throw Error("EventSource is in invalid state.")}this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&null!==this.initParams}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&null===this.initParams}close(){this.handleClose()}}function rc(e,t){if(!t.values)return t;{let e=[];for(let r of t.values?.entities){let t=ep(r.store);e.push({...r,store:t})}return{...t,values:{attrsStore:t.values.attrsStore.toJSON(),entities:e}}}}function rh(e,t,r){let n=t?.state?.txId,s=r?.state?.txId;return n&&(!s||n>s)?t:s&&(!n||s>n)?r:t||r}function rd(e,t,r){return e4({store:t,attrsStore:r,pageInfo:null,aggregate:null},e.query).data[e.table][0]}function rf(e,t,r,n){let s=eE(r,e.table,"id")?.id;if(!s)return -1;let i=ec(t.eav,[n,s,n]);return i?i[3]:-1}function rp(e,t,r){for(let{action:n,triple:s}of r)switch(n){case"added":eS(e,t,s);break;case"removed":ev(e,t,s)}}function ry(e,t){return{[e.table]:t.map(e=>e.entity)}}(r0=r1||(r1={})).InitialSyncBatch="InitialSyncBatch",r0.InitialSyncComplete="InitialSyncComplete",r0.LoadFromStorage="LoadFromStorage",r0.SyncTransaction="SyncTransaction",r0.Error="Error";class rg{trySend;subs;callbacks={};config;idToHash={};log;createStore;getAttrs;constructor(e,t,r,n,s,i){this.trySend=e,this.config=r,this.log=n,this.createStore=s,this.getAttrs=i,this.subs=new tg({persister:t,merge:rh,serialize:rc,parse:(e,t)=>(function(e,t){let r=e.values;if(r){let e=eg(r.attrsStore,null);if(e){for(let n of r.entities||[])n.store.useDateObjects=t,n.store=ey(e,n.store);r.attrsStore=e}}return e})(t,this.config.useDateObjects),objectSize:e=>e.values?.entities.length||0,logger:n,gc:{maxAgeMs:314496e5,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,t){let r=n(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(t),this.initSubscription(e,r,t),e=>{this.unsubscribe(r,t,e?.keepSubscription)}}unsubscribe(e,t,r){let n=(this.callbacks[e]||[]).filter(e=>e!==t);if(this.callbacks[e]=n,!n.length){delete this.callbacks[e];let t=this.subs.currentValue[e];t?.state&&this.clearSubscriptionData(t.state.subscriptionId,!!r),r||this.subs.updateInPlace(t=>{delete t[e]})}}sendStart(e){this.trySend(eF(),{op:"start-sync",q:e})}sendResync(e,t,r){this.idToHash[t.subscriptionId]=e.hash,this.trySend(t.subscriptionId,{op:"resync-table","subscription-id":t.subscriptionId,"tx-id":r,token:t.token})}sendRemove(e,t){this.trySend(eF(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":t})}async initSubscription(e,t,r){await this.subs.waitForKeyToLoad(t);let n=this.subs.currentValue[t];if(n&&n.state&&n.state.txId){this.sendResync(n,n.state,n.state.txId),n.values?.entities&&r&&r({type:r1.LoadFromStorage,data:ry(n,n.values?.entities)});return}let s=Object.keys(e)[0],[i,o]=Object.entries(e[s]?.$?.order||{serverCreatedAt:"asc"})[0];this.subs.updateInPlace(r=>{r[t]={query:e,hash:t,table:s,orderDirection:o,orderField:i,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)}async flushPending(){for(let e of Object.keys(this.callbacks)){await this.subs.waitForKeyToLoad(e);let t=this.subs.currentValue[e];t?await this.initSubscription(t.query,t.hash):this.log.error("Missing sub for hash in flushPending",e)}}onStartSyncOk(e){let t=e["subscription-id"],r=e.q,s=n(r);this.idToHash[t]=s,this.subs.updateInPlace(n=>{let i=n[s];if(!i)return this.log.error("Missing sub for hash",s,"subscription-id",t,"query",r),n;i.state={subscriptionId:t,token:e.token}})}notifyCbs(e,t){for(let r of this.callbacks[e]||[])r(t)}onSyncLoadBatch(e){let t=e["subscription-id"],r=e["join-rows"],n=this.idToHash[t];if(!n)return void this.log.error("Missing hash for subscription",e);let s=[],i=this.subs.currentValue[n];if(!i)return void this.log.error("Missing sub for hash",n,e);let o=i.values??{entities:[],attrsStore:this.getAttrs()};i.values=o;let a=o.entities;for(let e of r){let t=this.createStore(e),r=rd(i,t,o.attrsStore);a.push({store:t,entity:r,serverCreatedAt:rf(i,t,o.attrsStore,r.id)}),s.push(r)}this.subs.updateInPlace(e=>{e[n]=i,e[n].updatedAt=Date.now()}),i.values&&this.notifyCbs(n,{type:r1.InitialSyncBatch,data:ry(i,i.values.entities),batch:s})}onSyncInitFinish(e){let t=e["subscription-id"],r=this.idToHash[t];if(!r)return void this.log.error("Missing hash for subscription",e);this.subs.updateInPlace(t=>{let n=t[r];if(!n)return void this.log.error("Missing sub for hash",r,e);let s=n.state;if(!s)return this.log.error("Sub never set init, missing result",n,e),t;s.txId=e["tx-id"],n.updatedAt=Date.now()});let n=this.subs.currentValue[r];n&&this.notifyCbs(r,{type:r1.InitialSyncComplete,data:ry(n,n.values?.entities||[])})}onSyncUpdateTriples(e){let t=e["subscription-id"],r=this.idToHash[t];if(!r)return void this.log.error("Missing hash for subscription",e);let n=this.subs.currentValue[r];if(!n)return void this.log.error("Missing sub for hash",r,e);let s=n.state;if(!s)return void this.log.error("Missing state for sub",n,e);for(let t of e.txes){if(s.txId&&s.txId>=t["tx-id"])continue;s.txId=t["tx-id"];let e=[],o={};for(let e of t.changes){let t=o[e.triple[0]]??[];o[e.triple[0]]=t,t.push(e)}let a=n.values??{entities:[],attrsStore:this.getAttrs()},l=a.entities;n.values=a;let u=[];e:for(let[t,r]of Object.entries(o))for(let s=0;s<l.length;s++){var i;let c=l[s];if(i=c.store,void 0!==ec(i.eav,[t])){rp(c.store,a.attrsStore,r);let i=rd(n,c.store,a.attrsStore),l=function(e,t,r){let n={};for(let{action:e,triple:s}of r){let[r,i,o]=s,a=t.getAttr(i)?.["forward-identity"]?.[2];if(!a)continue;let l=n[r]??{};n[r]=l;let u=l[a]??{};switch(e){case"added":u.newValue=o;break;case"removed":void 0===u.oldValue&&(u.oldValue=o)}l[a]=u}for(let[e,t]of Object.entries(n))for(let[e,{oldValue:r,newValue:n}]of Object.entries(t))r===n&&delete t[e];return n}(c.store,a.attrsStore,r)[t];i?(u.push({oldEntity:c.entity,newEntity:i,changedFields:l||{}}),c.entity=i):e.push(s),delete o[t];continue e}}let c=[];for(let[e,t]of Object.entries(o)){let e=this.createStore([]);rp(e,a.attrsStore,t);let r=rd(n,e,a.attrsStore);if(!r){this.log.error("No entity found after applying change",{sub:n,changes:t,store:e});continue}l.push({store:e,entity:r,serverCreatedAt:rf(n,e,a.attrsStore,r.id)}),c.push(r)}let h=[];for(let t of e.sort().reverse())h.push(l[t].entity),l.splice(t,1);let d=function(e,t){if(e.orderFieldType)return e.orderFieldType;let r="serverCreatedAt"===e.orderField?"number":eE(t(),e.table,e.orderField)?.["checked-data-type"];return e.orderFieldType=r,r}(n,this.getAttrs);!function(e,t,r){if("serverCreatedAt"===e.orderField)return r.sort("asc"===e.orderDirection?function(e,r){return e0(e.entity.id,e.serverCreatedAt,r.entity.id,r.serverCreatedAt,t)}:function(e,r){return e0(r.entity.id,r.serverCreatedAt,e.entity.id,e.serverCreatedAt,t)});let n=e.orderField;r.sort("asc"===e.orderDirection?function(e,r){return e0(e.entity.id,e.entity[n],r.entity.id,r.entity[n],t)}:function(e,r){return e0(r.entity.id,r.entity[n],e.entity.id,e.entity[n],t)})}(n,d,l),this.notifyCbs(r,{type:r1.SyncTransaction,data:ry(n,n.values?.entities),added:c,removed:h,updated:u})}this.subs.updateInPlace(e=>{e[r]=n,e[r].updatedAt=Date.now()})}clearSubscriptionData(e,t){let r=this.idToHash[e];if(r){delete this.idToHash[e];let n=this.subs.currentValue[r];if(n.state&&this.sendRemove(n.state,t),t?this.subs.unloadKey(r):this.subs.updateInPlace(e=>{delete e[r]}),n)return n}}onStartSyncError(e){let t=n(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},s=Object.keys(e["original-event"].q)[0];this.notifyCbs(t,{type:r1.Error,data:{[s]:[]},error:r})}onResyncError(e){let t=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(t,!1);r&&this.initSubscription(r.query,r.hash)}}class rb{items=[];resolvers=[];isClosed=!1;push(e){if(this.isClosed)return;let t=this.resolvers.shift();t?t({value:e,done:!1}):this.items.push(e)}close(){for(this.isClosed=!0;this.resolvers.length>0;)this.resolvers.shift()({value:void 0,done:!0})}async *[Symbol.asyncIterator](){for(;;)if(this.items.length>0)yield this.items.shift();else{if(this.isClosed)return;let{value:e,done:t}=await new Promise(e=>{this.resolvers.push(e)});if(t||!e)return;yield e}}}class rm{trySend;WStream;RStream;writeStreams={};startWriteStreamCbs={};readStreamIterators={};log;activeStreams=new Set;constructor({WStream:e,RStream:t,trySend:r,log:n}){this.WStream=e,this.RStream=t,this.trySend=r,this.log=n}createWriteStream(e){let{stream:t,addCompleteCb:r}=function({WStream:e,opts:t,startStream:r,appendStream:n,registerStream:s}){let i=t.clientId,o=null,a=null,l=eF(),u=!1,c=!1,h=[],d=[],f=[],p=!1,y=0,g=0,b=[],m=new TextEncoder;function v(){for(let e of(c=!0,h))e()}function _(){for(let e of f)try{e()}catch(e){}}function w(){p=!0}function S(e){let t=y,r=0,n=0;for(let{byteLen:s}of b){let i=t+s;if(i>e)break;t=i,r++,n+=s}r>0&&(y+=n,g-=n,b.splice(0,r))}function T(e,t){v(),e.error(t),_()}async function k(){let e=await r({clientId:i,reconnectToken:l,ruleParams:t.ruleParams});switch(e.type){case"ok":{let{streamId:t,offset:r}=e;o=t,S(r),b.length&&n({streamId:t,chunks:b.map(e=>e.chunk),offset:y}),p=!1;break}case"disconnect":w();break;case"error":a&&T(a,e.error)}}function O(){w(),k()}function E({offset:e,done:t}){S(e),t&&(u=!0,_())}async function A(e){a=e;let n=!0,i=0;for(;n;){let a=Date.now()+Math.min(15e3,500*(i-1));n=!1;let u=await r({clientId:t.clientId,reconnectToken:l,ruleParams:t.ruleParams});switch(u.type){case"ok":{let{streamId:t,offset:r}=u;if(0!==r)return void T(e,new tE("Write stream is corrupted"));for(let e of(o=t,d))e(o);s(t,{onDisconnect:w,onFlush:E,onConnectionReconnect:k,onAppendFailed:O}),p=!1;return}case"disconnect":n=!0,w(),i++,await new Promise(e=>{setTimeout(e,a-Date.now())});break;case"error":return void T(e,u.error)}}}return t.waitUntil&&t.waitUntil(new Promise(e=>{f.push(e)})),{stream:new class extends e{constructor(e,t){super(e,t)}async streamId(){return o||new Promise((e,t)=>{var r,n;let s=[],i=()=>{for(let e of s)e()};s.push((r=t=>{e(t),i()},d.push(r),()=>{let e=d.indexOf(r);-1!==e&&d.splice(e,1)})),s.push((n=()=>{t(new tE("Stream is closed.")),i()},h.push(n),()=>{let e=h.indexOf(n);-1!==e&&h.splice(e,1)}))})}}({async start(e){try{await A(e)}catch(t){T(e,t)}},write(e,t){let r=u?(T(t,new tE("Stream has been closed.")),null):o||(T(t,new tE("Stream has not been initialized.")),null);if(r){let t=m.encode(e).length;b.push({chunk:e,byteLen:t});let s=y+g;g+=t,p||n({streamId:r,chunks:[e],offset:s})}},close(){o?n({streamId:o,chunks:[],offset:y+g,isDone:!0}):_(),v()},abort(e){o?n({streamId:o,chunks:[],offset:y+g,isDone:!0,abortReason:e}):_(),v()}}),addCompleteCb:function(e){return f.push(e),()=>{let t=f.indexOf(e);-1!==t&&f.splice(t,1)}},closed:()=>c}}({WStream:this.WStream,startStream:this.startWriteStream.bind(this),appendStream:this.appendStream.bind(this),registerStream:this.registerWriteStream.bind(this),opts:e});return this.activeStreams.add(t),r(()=>{this.activeStreams.delete(t)}),t}createReadStream(e){let{stream:t,addCloseCb:r}=function({RStream:e,opts:t,startStream:r,cancelStream:n}){let s,i=t.byteOffset||0,o=!1,a=new TextDecoder("utf-8"),l=new TextEncoder,u=!1,c=[];function h(){for(let e of(u=!0,c))e()}function d(e,t){e.error(t),h()}let f=0;async function p(e,t){for await(let n of(s=eF(),r({...e||{},eventId:s}))){if(o)return;if("reconnect"===n.type)return{retry:!0};if("error"===n.type)return void d(t,n.error);if(n.offset>i){d(t,new tE("Stream is corrupted.")),o=!0;return}let e=i-n.offset;if(n.files&&n.files.length){let r=new AbortController,s=fetch(n.files[0].url,{signal:r.signal});for(let l=0;l<n.files.length;l++){let u=n.files[l+1],c=s,h=await c;if(u&&(s=fetch(u.url,{signal:r.signal})),!h.ok){if(++f>10)return void d(t,new tE("Unable to process stream."));return{retry:!0}}if(h.body)for await(let n of h.body){if(o)return void r.abort();let s=n;if(e>0&&(s=n.subarray(e),e-=n.length-s.length),!s.length)continue;i+=s.length;let l=a.decode(s);t.enqueue(l)}else{let n=await h.arrayBuffer(),s=n;if(o)return void r.abort();if(e>0&&(s=new Uint8Array(n).subarray(e),e-=n.byteLength-s.length),!s.byteLength)continue;i+=s.byteLength;let l=a.decode(s);t.enqueue(l)}}}if(f=0,n.content){let r=n.content,s=l.encode(n.content);if(e>0){let t=s.subarray(e);if(e-=s.length-t.length,!t.length)continue;s=t,r=a.decode(t)}i+=s.length,t.enqueue(r)}}}async function y(e){let r=!0,n=0;for(;r;){r=!1;let s=Date.now()+Math.min(15e3,500*(n-1)),o=await p({...t,offset:i},e);o?.retry&&(r=!0,n++,s<Date.now()-3e5&&(n=0),await new Promise(e=>{setTimeout(e,s-Date.now())}))}o||u||(e.close(),h())}return{stream:new e({start(e){y(e)},cancel(e){o=!0,s&&n({eventId:s}),h()}}),addCloseCb:function(e){return c.push(e),()=>{let t=c.indexOf(e);-1!==t&&c.splice(t,1)}},closed:()=>u}}({RStream:this.RStream,opts:e,startStream:this.startReadStream.bind(this),cancelStream:this.cancelReadStream.bind(this)});return this.activeStreams.add(t),r(()=>{this.activeStreams.delete(t)}),t}startWriteStream(e){let t=eF(),r=null,n=new Promise(e=>{r=e});this.startWriteStreamCbs[t]=r;let s={op:"start-stream","client-id":e.clientId,"reconnect-token":e.reconnectToken};return e.ruleParams&&(s["rule-params"]=e.ruleParams),this.trySend(t,s),n}registerWriteStream(e,t){this.writeStreams[e]=t}appendStream({streamId:e,chunks:t,isDone:r,offset:n,abortReason:s}){let i={op:"append-stream","stream-id":e,chunks:t,offset:n,done:!!r};s&&(i["abort-reason"]=s),this.trySend(eF(),i)}onAppendFailed(e){let t=this.writeStreams[e["stream-id"]];t&&t.onAppendFailed()}onStartStreamOk(e){let t=this.startWriteStreamCbs[e["client-event-id"]];t?(t({type:"ok",streamId:e["stream-id"],offset:e.offset}),delete this.startWriteStreamCbs[e["client-event-id"]]):this.log.info("No stream for start-stream-ok",e)}onStreamFlushed(e){let t=e["stream-id"],r=this.writeStreams[t];r?(r.onFlush({offset:e.offset,done:e.done}),e.done&&delete this.writeStreams[t]):this.log.info("No stream cbs for stream-flushed",e)}startReadStream({eventId:e,clientId:t,streamId:r,offset:n,ruleParams:s}){let i={op:"subscribe-stream"};if(!r&&!t)throw Error("Must provide one of streamId or clientId to subscribe to the stream.");r&&(i["stream-id"]=r),t&&(i["client-id"]=t),n&&(i.offset=n),s&&(i["rule-params"]=s);let o=new rb;return this.readStreamIterators[e]=o,this.trySend(e,i),o}cancelReadStream({eventId:e}){this.trySend(eF(),{op:"unsubscribe-stream","subscribe-event-id":e}),delete this.readStreamIterators[e]}onStreamAppend(e){let t=e["client-event-id"],r=this.readStreamIterators[t];if(!r)return void this.log.info("No iterator for read stream",e);if(e.error){e.retry?r.push({type:"reconnect"}):r.push({type:"error",error:new tE(e.error)}),r.close(),delete this.readStreamIterators[t];return}(e.files?.length||e.content)&&r.push({type:"append",offset:e.offset,files:e.files,content:e.content}),e.done&&(r.close(),delete this.readStreamIterators[t])}onConnectionStatusChange(e){for(let e of Object.values(this.startWriteStreamCbs))e({type:"disconnect"});if(this.startWriteStreamCbs={},e!==rv.AUTHENTICATED)for(let{onDisconnect:e}of Object.values(this.writeStreams))e();else{for(let{onConnectionReconnect:e}of Object.values(this.writeStreams))e();for(let e of Object.values(this.readStreamIterators))e.push({type:"reconnect"}),e.close();this.readStreamIterators={}}}onRecieveError(e){let t=e["original-event"];switch(t.op){case"append-stream":{let e=t["stream-id"],r=this.writeStreams[e];r?.onAppendFailed();break}case"start-stream":{let t=e["client-event-id"],r=this.startWriteStreamCbs[t];r&&(r({type:"error",error:new tE(e.message||"Unknown error",e.hint)}),delete this.startWriteStreamCbs[t]);break}case"subscribe-stream":{let t=e["client-event-id"],r=this.readStreamIterators[t];r&&(r.push({type:"error",error:new tE(e.message||"Unknown error",e.hint)}),r.close(),delete this.readStreamIterators[t])}}}hasActiveStreams(){return this.activeStreams.size>0}}let rv={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},r_={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},rw="_instant_oauth_redirect",rS="currentUser",rT={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function rk(e,t){let{result:r,...n}=t;return r&&(n.result={...r,store:ep(r.store),attrsStore:r.attrsStore.toJSON()}),n}function rO(e,t){return"pendingMutations"===e?new Map("string"==typeof t?JSON.parse(t):t):t}function rE(e,t){return"pendingMutations"===e?[...t.entries()]:t}function rA(e,t,r){let n=t?.result,s=r?.result;return n&&!s&&r&&(r.result=n),r||t}function rI(e){return[...e].sort((e,t)=>{let[r,n]=e,[s,i]=t,o=n.order||0,a=i.order||0;return o==a?r<s?-1:+(r>s):o-a})}class rC{attrs;_isOnline=!0;_isShutdown=!1;status=rv.CONNECTING;querySubs;kv;_syncTable;_instantStream;queryCbs={};queryOnceDfds={};authCbs=[];attrsCbs=[];mutationErrorCbs=[];connectionStatusCbs=[];config;mutationDeferredStore=new Map;_reconnectTimeoutId=null;_reconnectTimeoutMs=0;_transport;_transportType="ws";_EventSource;_wsOk=null;_localIdPromises={};_errorMessage=null;_oauthCallbackResponse=null;_linkIndex=null;_broadcastChannel;_rooms={};_roomsPendingLeave={};_presence={};_broadcastQueue=[];_broadcastSubs={};_currentUserCached={isLoading:!0,error:void 0,user:void 0};_beforeUnloadCbs=[];_dataForQueryCache={};_log;_pendingTxCleanupTimeout;_pendingMutationCleanupThreshold;_inFlightMutationEventIds=new Set;constructor(e,t=tk,r=tO,n,s){if(this._EventSource=s,this.config={...r_,...e},this.queryCacheLimit=this.config.queryCacheLimit??10,this._pendingTxCleanupTimeout=this.config.pendingTxCleanupTimeout??3e4,this._pendingMutationCleanupThreshold=this.config.pendingMutationCleanupThreshold??200,this._log=function(e,t){return{info:e?(...e)=>console.info(...e,t()):()=>{},debug:e?(...e)=>console.debug(...e,t()):()=>{},error:e?(...e)=>console.error(...e,t()):()=>{}}}(e.verbose||tF||tK,()=>this._reactorStats()),this.versions={...n||{},"@instantdb/core":tG},this.config.schema&&(this._linkIndex=tQ(this.config.schema)),!function(){let e="u">typeof chrome;return"u">typeof window||e}())return;if(!e.appId)throw Error("Instant must be initialized with an appId.");if(!eU(e.appId))throw Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);"function"==typeof BroadcastChannel&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",async e=>{try{if(e.data?.type==="auth"){let e=await this.getCurrentUser();await this.updateUser(e.user).catch(e=>{this._log.error("[error] update user",e)})}}catch(e){this._log.error("[error] handle broadcast channel",e)}})),this._initStorage(t),this._syncTable=new rg(this._trySendAuthed.bind(this),new t(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,e=>eb(this.ensureAttrs(),e,this.config.enableCardinalityInference,this.config.useDateObjects),()=>this.ensureAttrs()),this._instantStream=new rm({WStream:this.config.WritableStream||WritableStream,RStream:this.config.ReadableStream||ReadableStream,trySend:this._trySendAuthed.bind(this),log:this._log}),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser().then(e=>{this.syncUserToEndpoint(e.user)}),setInterval(async()=>{let e=await this.getCurrentUser();this.syncUserToEndpoint(e.user)},6e4),r.getIsOnline().then(e=>{this._isOnline=e,this._startSocket(),r.listen(e=>{e!==this._isOnline&&(this._log.info("[network] online =",e),this._isOnline=e,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",rv.CLOSED),this._setStatus(rv.CLOSED)))})}),"u">typeof addEventListener&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}ensureAttrs(){if(!this.attrs)throw Error("attrs have not loaded.");return this.attrs}updateSchema(e){this.config={...this.config,schema:e,cardinalityInference:!!e},this._linkIndex=e?tQ(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new tg({persister:new e(this.config.appId,"querySubs"),merge:rA,serialize:rk,parse:(e,t)=>(function(e,t){let r="string"==typeof e?JSON.parse(e):e;if(r?.result?.store){let e=eg(r.result.attrsStore,r.result.store);if(e){let n=r.result.store;r.result.store=ey(e,{...n,useDateObjects:t}),r.result.attrsStore=e}}return r})(t,this.config.useDateObjects),objectSize:e=>e?.result?.store?.triples?.length??0,logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:314496e5,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=e=>this._onQuerySubLoaded(e),this.kv=new tg({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:rE,parse:rO,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=e=>{"pendingMutations"===e&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(rS),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(let e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,t,r){let n=this.mutationDeferredStore.get(t);this.mutationDeferredStore.delete(t);let s="error"!==e&&"timeout"!==e;if(n||s||console.error("Mutation failed",{status:e,eventId:t,...r}),n)if(s)n.resolve({status:e,eventId:t});else if(r?.type){let{status:e,...t}=r;n.reject(new tA({body:t,status:e??0}))}else n.reject(new tE(r?.message||"Unknown error",r?.hint))}_setStatus(e,t){this.status=e,this._errorMessage=t,this.notifyConnectionStatusSubs(e),this._instantStream.onConnectionStatusChange(e)}_onMergeKv=(e,t,r)=>{if("pendingMutations"!==e)return r||t;{let e=new Map([...t?.entries()??[],...r?.entries()??[]]);return(t?this._rewriteMutationsSorted(this.attrs,t):[]).forEach(([e,t])=>{r?.pendingMutations?.has(e)||t["tx-id"]||this._sendMutation(e,t)}),e}};_flushEnqueuedRoomData(e){let t=this._presence[e]?.result?.user,r=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],t&&this._trySetPresence(e,t),r)for(let t of r){let{topic:r,roomType:n,data:s}=t;this._tryBroadcast(e,n,r,s)}}_addQueryData(e,t,r){if(!this.attrs)throw Error("Attrs in reactor have not been set");let s=n(e),i=this.ensureAttrs(),o=eb(this.attrs,t.triples,r,this.config.useDateObjects);this.querySubs.updateInPlace(r=>{r[s]={result:{store:o,attrsStore:i,pageInfo:t.pageInfo,processedTxId:void 0,isExternal:!0},q:e}}),this._cleanupPendingMutationsQueries(),this.notifyOne(s),this.notifyOneQueryOnce(s),this._cleanupPendingMutationsTimeout()}_handleReceive(e,t){let r=!!this.config.schema&&(!("cardinalityInference"in this.config)||!!this.config.cardinalityInference);switch(!rT[t.op]&&this._log.info("[receive]",e,t.op,t),t.op){case"init-ok":for(let e of(this._setStatus(rv.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(t.attrs),this._flushPendingMessages(),this._sessionId=t["session-id"],Object.keys(this._rooms))){let t=this._presence[e]?.result?.user,r=this._rooms[e]?.roomType;this._tryJoinRoom(r,e,t)}break;case"add-query-exists":this.notifyOneQueryOnce(n(t.q));break;case"add-query-ok":{let{q:e,result:s}=t,i=n(e);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[i])break;let o=s?.[0]?.data?.["page-info"],a=s?.[0]?.data?.aggregate,l=tV(s),u=this.ensureAttrs(),c=eb(u,l,r,this.config.useDateObjects);this.querySubs.updateInPlace(r=>{r[i]?r[i].result={store:c,attrsStore:u,pageInfo:o,aggregate:a,processedTxId:t["processed-tx-id"]}:this._log.info("Missing value in querySubs",{hash:i,q:e})}),this._cleanupPendingMutationsQueries(),this.notifyOne(i),this.notifyOneQueryOnce(i),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":this._syncTable.onStartSyncOk(t);break;case"sync-load-batch":this._syncTable.onSyncLoadBatch(t);break;case"sync-init-finish":this._syncTable.onSyncInitFinish(t);break;case"sync-update-triples":this._syncTable.onSyncUpdateTriples(t);break;case"start-stream-ok":this._instantStream.onStartStreamOk(t);break;case"stream-flushed":this._instantStream.onStreamFlushed(t);break;case"append-failed":this._instantStream.onAppendFailed(t);break;case"stream-append":this._instantStream.onStreamAppend(t);break;case"refresh-ok":{let{computations:e,attrs:s}=t,i=t["processed-tx-id"];s&&this._setAttrs(s),this._cleanupPendingMutationsTimeout();let o=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations(),i);o!==this._pendingMutations()&&this.kv.updateInPlace(e=>{e.pendingMutations=o});let a=rI(o.entries()),l=e.map(e=>{let t=e["instaql-query"],s=e["instaql-result"],o=n(t),l=tV(s),u=this.ensureAttrs(),c=eb(u,l,r,this.config.useDateObjects),{store:h,attrsStore:d}=this._applyOptimisticUpdates(c,u,a,i);return{q:t,hash:o,store:h,attrsStore:d,pageInfo:s?.[0]?.data?.["page-info"],aggregate:s?.[0]?.data?.aggregate}});l.forEach(({hash:e,q:t,store:r,attrsStore:n,pageInfo:s,aggregate:o})=>{this.querySubs.updateInPlace(a=>{a[e]?a[e].result={store:r,attrsStore:n,pageInfo:s,aggregate:o,processedTxId:i}:this._log.error("Missing value in querySubs",{hash:e,q:t})})}),this._cleanupPendingMutationsQueries(),l.forEach(({hash:e})=>{this.notifyOne(e)});break}case"transact-ok":{let{"client-event-id":e,"tx-id":r}=t;this._inFlightMutationEventIds.delete(e);let n=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations()).get(e);if(!n)break;this._updatePendingMutations(t=>{t.set(e,{...t.get(e),"tx-id":r,confirmed:Date.now()})});let s=[];for(let e of n["tx-steps"])if("add-attr"===e[0]){let t=e[1];s.push(t)}if(s.length){let e=Object.values(this.ensureAttrs().attrs);this._setAttrs([...e,...s])}this._finishTransaction("synced",e),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{let e=t["room-id"];this._trySetRoomConnected(e,!0),this._patchPresencePeers(e,t.edits),this._notifyPresenceSubs(e);break}case"refresh-presence":{let e=t["room-id"];this._trySetRoomConnected(e,!0),this._setPresencePeers(e,t.data),this._notifyPresenceSubs(e);break}case"server-broadcast":{let e=t["room-id"],r=t.topic;this._trySetRoomConnected(e,!0),this._notifyBroadcastSubs(e,r,t);break}case"join-room-ok":{let e=t["room-id"];if(!this._rooms[e]){this._roomsPendingLeave[e]&&(this._tryLeaveRoom(e),delete this._roomsPendingLeave[e]);break}this._trySetRoomConnected(e,!0),this._flushEnqueuedRoomData(e);break}case"leave-room-ok":{let e=t["room-id"];this._trySetRoomConnected(e,!1);break}case"join-room-error":let s=t["room-id"],i=this._rooms[s];i&&(i.error=t.error),this._notifyPresenceSubs(s);break;case"error":this._handleReceiveError(t);break;default:this._log.info("Unknown op",t.op,t)}}createWriteStream(e){return this._instantStream.createWriteStream(e)}createReadStream(e){return this._instantStream.createReadStream(e)}_pendingMutations(){return this.kv.currentValue.pendingMutations??new Map}_updatePendingMutations(e){this.kv.updateInPlace(t=>{let r=t.pendingMutations??new Map;t.pendingMutations=r,e(r)})}_handleMutationError(e,t,r){let n=this._pendingMutations().get(t);if(n&&("timeout"!==e||!n["tx-id"])){this._updatePendingMutations(e=>(e.delete(t),e)),this._inFlightMutationEventIds.delete(t);let n={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(n),this._finishTransaction(e,t,r)}}_handleReceiveError(e){console.log("error",e);let t=e["client-event-id"];this._inFlightMutationEventIds.delete(t);let r=this._pendingMutations().get(t),s={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(s.hint=e.hint),r)return void this._handleMutationError("error",t,e);if(e["original-event"]?.hasOwnProperty("q")&&e["original-event"]?.op==="add-query"){let r=e["original-event"]?.q,i=n(r);this.notifyQueryError(n(r),s),this.notifyQueryOnceError(r,i,t,s);return}if(e["original-event"]?.op==="init")return"record-not-found"===e.type&&e.hint?.["record-type"]==="app-user"?void this.changeCurrentUser(null):(this._setStatus(rv.ERRORED,s),void this.notifyAll());switch(e["original-event"]?.op){case"resync-table":return void this._syncTable.onResyncError(e);case"start-sync":return void this._syncTable.onStartSyncError(e);case"start-stream":case"append-stream":case"subscribe-stream":case"unsubscribe-stream":return void this._instantStream.onRecieveError(e)}let i={...e};delete i.message,delete i.hint,console.error(e.message,i),e.hint&&console.error("This error comes with some debugging information. Here it is: \n",e.hint)}notifyQueryOnceError(e,t,r,n){let s=this.queryOnceDfds[t]?.find(e=>e.eventId===r);s&&(s.dfd.reject(n),this._completeQueryOnce(e,t,s.dfd))}_setAttrs(e){this.attrs=new ea(e.reduce((e,t)=>(e[t.id]=t,e),{}),this._linkIndex),this.notifyAttrsSubs()}getPreviousResult=e=>{let t=n(e);return this.dataForQuery(t)?.data};_startQuerySub(e,t){let r=eF();return this.querySubs.updateInPlace(n=>{n[t]=n[t]||{q:e,result:null,eventId:r},n[t].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,t){return this._syncTable.subscribe(e,t)}subscribeQuery(e,t,r){this.config.disableValidation||t8(e,this.config.schema),r&&"ruleParams"in r&&(e={$$ruleParams:r.ruleParams,...e});let s=n(e),i=this.getPreviousResult(e);return i&&t(i),this.queryCbs[s]=this.queryCbs[s]??[],this.queryCbs[s].push({q:e,cb:t}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,t)}}queryOnce(e,t){this.config.disableValidation||t8(e,this.config.schema),t&&"ruleParams"in t&&(e={$$ruleParams:t.ruleParams,...e});let r=new tz;if(!this._isOnline)return r.reject(Error("We can't run `queryOnce`, because the device is offline.")),r.promise;if(!this.querySubs)return r.reject(Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),r.promise;let s=n(e),i=this._startQuerySub(e,s);return this.queryOnceDfds[s]=this.queryOnceDfds[s]??[],this.queryOnceDfds[s].push({q:e,dfd:r,eventId:i}),setTimeout(()=>r.reject(Error("Query timed out")),3e4),r.promise}_completeQueryOnce(e,t,r){this.queryOnceDfds[t]&&(this.queryOnceDfds[t]=this.queryOnceDfds[t].filter(e=>e.dfd!==r),this._cleanupQuery(e,t))}_unsubQuery(e,t,r){this.queryCbs[t]&&(this.queryCbs[t]=this.queryCbs[t].filter(e=>e.cb!==r),this._cleanupQuery(e,t))}_hasQueryListeners(e){return!!(this.queryCbs[e]?.length||this.queryOnceDfds[e]?.length)}_cleanupQuery(e,t){this._hasQueryListeners(t)||(delete this.queryCbs[t],delete this.queryOnceDfds[t],delete this._dataForQueryCache[t],this.querySubs.unloadKey(t),this._trySendAuthed(eF(),{op:"remove-query",q:e}))}_rewriteMutations(e,t,r){if(!e)return t;if(!t)return new Map;let n=t=>{let[r,n,s]=t["forward-identity"];return eE(e,n,s)},s=t=>{let[r,n,s]=t["forward-identity"];return eA(e,n,s)},i={attrIdMap:{},refSwapAttrIds:new Set},o=!1,a=(e,t)=>{let a=[];for(let l of e){let[e]=l;if("add-attr"===e){let[e,t]=l,r=n(t);if(r&&t.id!==r.id){i.attrIdMap[t.id]=r.id,o=!0;continue}if("ref"===t["value-type"]){let e=s(t);if(e){i.attrIdMap[t.id]=e.id,i.refSwapAttrIds.add(t.id),o=!0;continue}}}if(r&&t&&r>=t&&"add-attr"===e||"update-attr"===e||"delete-attr"===e){o=!0;continue}let u=o?function(e,t){let{attrIdMap:r,refSwapAttrIds:n}=e,s=[];for(let e of t){let t=r[e];if(t)s.push(t);else if(Array.isArray(e)&&2==e.length&&r[e[0]]){let[t,n]=e;s.push([r[t],n])}else s.push(e)}let[i]=t;if(("add-triple"===i||"retract-triple"===i)&&n.has(t[2])){let e=s[1];s[1]=s[3],s[3]=e}return s}(i,l):l;a.push(u)}return o?a:e},l=new Map;for(let[e,r]of t.entries())l.set(e,{...r,"tx-steps":a(r["tx-steps"],r["tx-id"])});return o?l:t}_rewriteMutationsSorted(e,t){return rI(this._rewriteMutations(e,t).entries())}optimisticAttrs(){let e=[...this._pendingMutations().values()].flatMap(e=>e["tx-steps"]),t=new Set(e.filter(([e,t])=>"delete-attr"===e).map(([e,t])=>t)),r=[];for(let[t,n]of e)if("add-attr"===t)r.push(n);else if("update-attr"===t&&n.id&&this.attrs?.getAttr(n.id)){let e={...this.attrs.getAttr(n.id),...n};r.push(e)}if(!t.size&&!r.length)return this.attrs||new ea({},this._linkIndex);let n={...this.attrs?.attrs||{}};for(let e of r)n[e.id]=e;for(let e of t)delete n[e];return new ea(n,this._linkIndex)}dataForQuery(e,t=!0){let r=this._errorMessage;if(r)return{error:r};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;let n=this.querySubs.version(),s=this.querySubs.currentValue,i=this.kv.version(),o=this._pendingMutations(),{q:a,result:l}=s[e]||{};if(!l)return;let u=this._dataForQueryCache[e];if(u&&n===u.querySubVersion&&i===u.pendingMutationsVersion)return u;let c=l.store,h=l.attrsStore,{pageInfo:d,aggregate:f,processedTxId:p}=l,y=this._rewriteMutationsSorted(h,o);if(t){let e=this._applyOptimisticUpdates(c,h,y,p);c=e.store,h=e.attrsStore}return{data:e4({store:c,attrsStore:h,pageInfo:d,aggregate:f},a),querySubVersion:n,pendingMutationsVersion:i}}_applyOptimisticUpdates(e,t,r,n){for(let[s,i]of r)if(!i["tx-id"]||n&&i["tx-id"]>n){let r=function(e,t,r){let n=r.filter(([r,n,s,i,o])=>{if("add-triple"!==r&&"deep-merge-triple"!==r)return!0;let a=o?.mode;if("create"!==a&&"update"!==a)return!0;let l=!1,u=t.getAttr(s);if(u){let r=eI(t,u["forward-identity"][1]);l=!!function(e,t,r){let n=em(e,r);if(!n)return;let[s,i,o]=n;if(t.getAttr(i))return ec(e.eav,[s,i])}(e,t,[n,r?.id,n])}return("create"!==a||!l)&&("update"!==a||!!l)});return B({store:e,attrsStore:t},e=>{n.forEach(t=>{!function(e,t,r){let[n,...s]=r;switch(n){case"add-triple":eS(e,t,s);break;case"deep-merge-triple":!function(e,t,r){let n=em(e,r);if(!n)return;let[s,i,o]=n,a=t.getAttr(i);if(!a)return;if(!eu(a))throw Error("merge operation is not supported for links");let l=ec(e.eav,[s,i]);if(!l)return;let u=l.values().next()?.value;if(!u)return;let c=function e(t,r){if(!X(t)||!X(r))return r;let n={...t};for(let s of Object.keys(r)){if(void 0===r[s])continue;if(null===r[s]){delete n[s];continue}let i=X(t[s])&&X(r[s]);n[s]=i?e(t[s],r[s]):r[s]}return n}(u[2],o),h=[s,i,c,ew(e,a,u)];ed(e.eav,[s,i],new Map([[c,h]])),ed(e.aev,[i,s],new Map([[c,h]]))}(e,t,s);break;case"retract-triple":ev(e,t,s);break;case"delete-entity":!function e(t,r,n){let[s,i]=n,o=em(t,[s]);if(!o)return;let[a]=o,l=t.eav.get(a);if(l){for(let n of l.keys()){let s=r.getAttr(n);s&&"cascade"===s["on-delete-reverse"]&&ek(l.get(n),1).forEach(([n,i,o])=>e(t,r,[o,s["reverse-identity"]?.[1]])),i&&s&&s["forward-identity"]?.[1]!==i||(eh(t.aev,[n,a]),eh(t.eav,[a,n]))}0===l.size&&eh(t.eav,[a])}let u=t.vae.get(a)&&ek(t.vae.get(a),2);u&&u.forEach(n=>{let[s,o,a]=n,l=r.getAttr(o);i&&l&&l["reverse-identity"]?.[1]!==i||(eh(t.eav,[s,o,a]),eh(t.aev,[o,s,a]),eh(t.vae,[a,o,s])),l&&"cascade"===l["on-delete"]&&l["reverse-identity"]?.[1]===i&&e(t,r,[s,l["forward-identity"]?.[1]])}),t.vae.get(a)?.size===0&&eh(t.vae,[a])}(e,t,s);break;case"add-attr":!function(e,[t]){e.addAttr(t)}(t,s);break;case"delete-attr":!function(e,t,[r]){if(!t.getAttr(r))return;let n=ek(e.eav,3).filter(([e,t])=>t!==r);t.deleteAttr(r),eT(e,t,n)}(e,t,s);break;case"update-attr":!function(e,t,[r]){t.getAttr(r.id)&&(t.updateAttr(r),eT(e,t,ek(e.eav,3)))}(e,t,s);break;case"restore-attr":case"rule-params":break;default:throw Error(`unhandled transaction action: ${n}`)}}(e.store,e.attrsStore,t)})},{mark:e=>{if(e instanceof ea)return"immutable"}})}(e,t,i["tx-steps"]);e=r.store,t=r.attrsStore}return{store:e,attrsStore:t}}notifyOne=e=>{let t=this.queryCbs[e]??[],r=this._dataForQueryCache[e]?.data,n=this.dataForQuery(e);!n?.data||(this._dataForQueryCache[e]=n,Z(n.data,r)||t.forEach(e=>e.cb(n.data)))};notifyOneQueryOnce=e=>{let t=this.queryOnceDfds[e]??[],r=this.dataForQuery(e)?.data;t.forEach(t=>{this._completeQueryOnce(t.q,e,t.dfd),t.dfd.resolve(r)})};notifyQueryError=(e,t)=>{(this.queryCbs[e]||[]).forEach(e=>e.cb({error:t}))};notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}pushTx=e=>{this.config.disableValidation||((e,t)=>{for(let r of Array.isArray(e)?e:[e]){if(!r||"object"!=typeof r)throw new t5(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new t5(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(let e of r.__ops){if(!Array.isArray(e))throw new t5(`Transaction operation must be an array, but received: ${typeof e}`);ro(e,t)}}})(e,this.config.schema);try{let t=function(e,t){let r=(Array.isArray(t)?t:[t]).flatMap(e=>e.__ops),[n,s]=function({attrsStore:e,schema:t},r){let n=new Set,s=[],i=[];function o(t,r){return eE(e,t,r)||s.find(e=>e["forward-identity"][1]===t&&e["forward-identity"][2]===r)}function a(t,r){return eA(e,t,r)||s.find(e=>e["reverse-identity"]?.[1]===t&&e["reverse-identity"]?.[2]===r)}function l(e){s.push(e),i.push(["add-attr",e]),n.add(e.id)}function u(e){e&&"isUnsynced"in e&&e.isUnsynced&&!n.has(e.id)&&(s.push(e),i.push(["add-attr",e]),n.add(e.id))}function c(e,t){return -1!==t.indexOf(".")&&!o(e,t)}function h(e,r){let n=o(e,r),s=a(e,r);u(n),u(s),n||s||l(to(t,e,r,td))}for(let e of r)for(let{etype:r,lookupPair:n,linkLabel:s}of function(e){let t=[],[r,n,s,i]=e;if(!tc.has(r))return t;let o=tt(s);if(o&&t.push({etype:n,lookupPair:o}),"link"===r)for(let[e,r]of Object.entries(i))for(let s of Array.isArray(r)?r:[r]){let r=tt(s);r&&t.push({etype:n,lookupPair:r,linkLabel:e})}return t}(e)){let e=n[0];if(s){h(r,s);let n=o(r,s),i=a(r,s);u(n),u(i);let d=n?.["reverse-identity"]?.[1]||i?.["forward-identity"]?.[1]||s;if(c(d,e))h(d,te(e));else{let r=o(d,e);r||l(ti(t,d,e,th)),u(r)}}else if(c(r,e))h(r,te(e));else{let n=o(r,e);n||l(ti(t,r,e,th)),u(n)}}for(let e of r){let[r,n,s,i]=e;if(ta.has(r)){let e=o(n,"id");for(let s of(u(e),e||l(ti(t,n,"id",{"unique?":!0})),Object.keys(i))){let e=o(n,s);if(u(e),tu.has(r)&&!e&&l(ti(t,n,s,"id"===s?{"unique?":!0}:null)),tl.has(r)){let r=a(n,s);e||r||l(to(t,n,s)),u(r)}}}}if(s.length){let t={...e.attrs};for(let e of s)t[e.id]=e;return[new ea(t,e.linkIndex),i]}return[e,i]}(e,r),i={...e,attrsStore:n};return[...s,...r.flatMap(e=>(function(e,t){let[r,...n]=function(e){let[t,r,n,s,i]=e;if(!s)return e;let o={...s};return delete o.id,[t,r,n,o,...i?[i]:[]]}(t);switch(r){case"merge":return function(e,t){let{attrsStore:r}=e,[n,s,i,o]=t,a=Y(i),l=tr(r,n,s),u=ts(e,[n,l,i,o]),c=Object.entries(a).map(([e,t])=>["deep-merge-triple",l,eE(r,n,e).id,t,...u?[u]:[]]);return[["add-triple",l,eE(r,n,"id").id,l,...u?[u]:[]]].concat(c)}(e,n);case"create":return function(e,t){let{attrsStore:r}=e,[n,s,i,o]=t,a=Y(i),l=tr(r,n,s);return[["id",l]].concat(Object.entries(a)).map(([t,s])=>{let i=eE(r,n,t);return"date"===i["checked-data-type"]&&e.useDateObjects&&(s=eo(s)),["add-triple",l,i.id,s,{mode:"create"}]})}(e,n);case"update":return function(e,t){let{attrsStore:r}=e,[n,s,i,o]=t,a=Y(i),l=tr(r,n,s),u=ts(e,[n,l,i,o]);return[["id",l]].concat(Object.entries(a)).map(([t,s])=>{let i=eE(r,n,t);return"date"===i["checked-data-type"]&&e.useDateObjects&&(s=eo(s)),["add-triple",l,i.id,s,...u?[u]:[]]})}(e,n);case"link":return function({attrsStore:e},[t,r,n]){let s=Object.entries(n).flatMap(([n,s])=>{let i=Array.isArray(s)?s:[s],o=eE(e,t,n),a=eA(e,t,n);return i.map(n=>o?["add-triple",tr(e,t,r),o.id,tr(e,o["reverse-identity"][1],n)]:["add-triple",tr(e,a["forward-identity"][1],n),a?.id,tr(e,t,r)])});return tn(e,t,r,s)}(e,n);case"unlink":return function({attrsStore:e},[t,r,n]){let s=Object.entries(n).flatMap(([n,s])=>{let i=Array.isArray(s)?s:[s],o=eE(e,t,n),a=eA(e,t,n);return i.map(n=>o?["retract-triple",tr(e,t,r),o.id,tr(e,o["reverse-identity"][1],n)]:["retract-triple",tr(e,a["forward-identity"][1],n),a.id,tr(e,t,r)])});return tn(e,t,r,s)}(e,n);case"delete":return function({attrsStore:e},[t,r]){return[["delete-entity",tr(e,t,r),t]]}(e,n);case"ruleParams":return function({attrsStore:e},[t,r,n]){return[["rule-params",tr(e,t,r),t,n]]}(e,n);default:throw Error(`unsupported action ${r}`)}})(i,e))]}({attrsStore:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(e=>e?.result?.store),useDateObjects:this.config.useDateObjects},e);return this.pushOps(t)}catch(e){return this.pushOps([],e)}};pushOps=(e,t)=>{let r=eF(),n=Math.max(0,...[...this._pendingMutations().values()].map(e=>e.order||0))+1,s={op:"transact","tx-steps":e,created:Date.now(),error:t,order:n};this._updatePendingMutations(e=>{e.set(r,s)});let i=new tz;return this.mutationDeferredStore.set(r,i),this._sendMutation(r,s),this.notifyAll(),i.promise};shutdown(){this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,this._transport?.close()}_sendMutation(e,t){if(t.error)return void this._handleMutationError("error",e,{message:t.error.message});if(this.status!==rv.AUTHENTICATED)return void this._finishTransaction("enqueued",e);let r=Math.max(6e3,6e3*Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1));this._isOnline?(this._trySend(e,t),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(e=>this.querySubs.currentValue[e]).filter(e=>e).forEach(({eventId:e,q:t})=>{this._trySendAuthed(e,{op:"add-query",q:t})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:e,q:t})=>{this._trySendAuthed(e,{op:"add-query",q:t})});let e=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations());e!==this._pendingMutations()&&this.kv.updateInPlace(t=>{t.pendingMutations=e}),rI(e.entries()).forEach(([e,t])=>{t["tx-id"]||this._sendMutation(e,t)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(let{result:t}of Object.values(this.querySubs.currentValue))t?.processedTxId&&(e=Math.min(e,t?.processedTxId));this._updatePendingMutations(t=>{for(let[r,n]of Array.from(t.entries()))n["tx-id"]&&n["tx-id"]<=e&&t.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;let e=Date.now();this._updatePendingMutations(t=>{for(let[r,n]of Array.from(t.entries()))n.confirmed&&n.confirmed+this._pendingTxCleanupTimeout<e&&t.delete(r)})}_trySendAuthed(...e){this.status===rv.AUTHENTICATED&&this._trySend(...e)}_trySend(e,t,r){if(this._transport.isOpen()){switch(!rT[t.op]&&this._log.info("[send]",this._transport.id,t.op,{"client-event-id":e,...t}),t.op){case"transact":this._inFlightMutationEventIds.add(e);break;case"init":this._inFlightMutationEventIds.clear()}this._transport.send({"client-event-id":e,...t})}}_transportOnOpen=e=>{let t=e.target;this._transport!==t?this._log.info("[socket][open]",t.id,"skip; this is no longer the current transport"):(this._log.info("[socket][open]",this._transport.id),this._setStatus(rv.OPENED),this.getCurrentUser().then(e=>{this._trySend(eF(),{op:"init","app-id":this.config.appId,"refresh-token":e.user?.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(e=>{this._log.error("[socket][error]",t.id,e)}))};_transportOnMessage=e=>{let t=e.target,r=e.message;if(this._transport!==t)return void this._log.info("[socket][message]",t.id,r,"skip; this is no longer the current transport");if(this._wsOk||"ws"!==t.type||(this._wsOk=!0),this._transportType="ws",Array.isArray(e.message))for(let r of e.message)this._handleReceive(t.id,r);else this._handleReceive(t.id,e.message)};_transportOnError=e=>{let t=e.target;this._transport!==t?this._log.info("[socket][error]",t.id,"skip; this is no longer the current transport"):this._log.error("[socket][error]",t.id,e)};_scheduleReconnect=()=>{this._wsOk||"sse"===this._transportType||(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),this._isOnline)?this._startSocket():this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket")},this._reconnectTimeoutMs)};_transportOnClose=e=>{let t=e.target;if(this._transport!==t)return void this._log.info("[socket][close]",t.id,"skip; this is no longer the current transport");for(let e of(this._setStatus(rv.CLOSED),Object.values(this._rooms)))e.isConnected=!1;this._isShutdown?this._log.info("[socket][close]",t.id,"Reactor has been shut down and will not reconnect"):(this._log.info("[socket][close]",t.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect())};_startSocket(){if(this._wsOk=null,this._isShutdown)return void this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");if(this._transport&&this._transport.isConnecting())return void this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");let e=this._transport;this._transport=function({transportType:e,appId:t,apiURI:r,wsURI:n,EventSourceImpl:s}){if(!s)return new rl(`${n}?app_id=${t}`);switch(e){case"ws":return new rl(`${n}?app_id=${t}`);case"sse":return new ru(s,`${r}/runtime/sse?app_id=${t}`);default:throw Error("Unknown transport type "+e)}}({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e?.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}async getLocalId(e){let t=`localToken_${e}`;if(this.kv.currentValue[t])return this.kv.currentValue[t];let r=await this.kv.waitForKeyToLoad(t);if(r)return r;let n=eF();return this.kv.updateInPlace(e=>{e[t]||(e[t]=n)}),await this.kv.waitForKeyToLoad(t)}_replaceUrlAfterOAuth(){if("u"<typeof URL)return;let e=new URL(window.location.href);if(e.searchParams.get(rw)){let t=e.toString();e.searchParams.delete(rw),e.searchParams.delete("code"),e.searchParams.delete("error");let r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),"object"==typeof navigation&&"function"==typeof navigation.addEventListener&&"function"==typeof navigation.removeEventListener){let e=!1,n=s=>{!e&&(e=!0,navigation.removeEventListener("navigate",n),s.userInitiated||"replace"!==s.navigationType||s.destination?.url!==t||history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",n)}}}async _oauthLoginInit(){if("u"<typeof window||void 0===window.location||"u"<typeof URLSearchParams)return null;let e=new URLSearchParams(window.location.search);if(!e.get(rw))return null;let t=e.get("error");if(t)return this._replaceUrlAfterOAuth(),{error:{message:t}};let r=e.get("code");if(!r)return null;this._replaceUrlAfterOAuth();try{let e=await this._getCurrentUser(),t=e?.type==="guest",{user:n}=await tP({apiURI:this.config.apiURI,appId:this.config.appId,code:r,refreshToken:t?e.refresh_token:void 0});return this.setCurrentUser(n),null}catch(e){if(e?.body?.type==="record-not-found"&&e?.body?.hint?.["record-type"]==="app-oauth-code"&&await this._hasCurrentUser())return null;return{error:{message:e?.body?.message||"Error logging in."}}}}async _waitForOAuthCallbackResponse(){return await this._oauthCallbackResponse}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(t=>t!==e)}}subscribeAuth(e){this.authCbs.push(e);let t=this._currentUserCached;t.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(n=>{r||Z(n,t)||e(n)}),()=>{r=!0,this.authCbs=this.authCbs.filter(t=>t!==e)}}async getAuth(){let{user:e,error:t}=await this.getCurrentUser();if(t)throw new tE("Could not get current user: "+t.message);return e}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(t=>t!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(t=>t!==e)}}notifyAuthSubs(e){this.authCbs.forEach(t=>t(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(t=>t(e))}notifyAttrsSubs(){if(!this.attrs)return;let e=this.optimisticAttrs();this.attrsCbs.forEach(t=>t(e.attrs))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(t=>t(e))}async setCurrentUser(e){this.kv.updateInPlace(t=>{t[rS]=e}),await this.kv.waitForKeyToLoad(rS)}getCurrentUserCached(){return this._currentUserCached}async _getCurrentUser(){let e=await this.kv.waitForKeyToLoad(rS);return"string"==typeof e?JSON.parse(e):e}async getCurrentUser(){let e=await this._waitForOAuthCallbackResponse();if(e?.error){let t={error:e.error,user:void 0};return this._currentUserCached={isLoading:!1,...t},t}try{let e={user:await this._getCurrentUser(),error:void 0};return this._currentUserCached={isLoading:!1,...e},e}catch(e){return{user:void 0,isLoading:!1,error:{message:e?.message||"Error loading user"}}}}async _hasCurrentUser(){let e=await this.kv.waitForKeyToLoad(rS);return"string"==typeof e?null!=JSON.parse(e):null!=e}async changeCurrentUser(e){let{user:t}=await this.getCurrentUser();if(!Z(t,e)){await this.setCurrentUser(e),await this.updateUser(e);try{this._broadcastChannel?.postMessage({type:"auth"})}catch(e){console.error("Error posting message to broadcast channel",e)}}}async syncUserToEndpoint(e){if(this.config.firstPartyPath)try{await fetch(this.config.firstPartyPath+"/",{method:"POST",body:JSON.stringify({type:"sync-user",appId:this.config.appId,user:e}),headers:{"Content-Type":"application/json"}})}catch(e){this._log.error("Error syncing user with external endpoint",e)}}async updateUser(e){try{await this.syncUserToEndpoint(e)}catch(e){this._log.error("Error syncing user with external endpoint",e)}let t={error:void 0,user:e};this._currentUserCached={isLoading:!1,...t},this._dataForQueryCache={},this.querySubs.updateInPlace(e=>{Object.keys(e).forEach(t=>{delete e[t].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(t)}sendMagicCode({email:e}){return function({apiURI:e,appId:t,email:r}){return tI(`${e}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":t,email:r})})}({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}async signInWithMagicCode({email:e,code:t}){let r=await this.getCurrentUser(),n=r?.user?.type==="guest",s=await tC({apiURI:this.config.apiURI,appId:this.config.appId,email:e,code:t,refreshToken:n?r.user.refresh_token:void 0});return await this.changeCurrentUser(s.user),s}async signInWithCustomToken(e){let t=await tM({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return await this.changeCurrentUser(t.user),t}async signInAsGuest(){let e=await tx({apiURI:this.config.apiURI,appId:this.config.appId});return await this.changeCurrentUser(e.user),e}potentiallyInvalidateToken(e,t){let r=e?.user?.refresh_token;r&&(!1===t.invalidateToken?this._log.info("[auth-invalidate] skipped invalidateToken"):t$({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:r}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(e=>{}))}async signOut(e){let t=await this.getCurrentUser();this.potentiallyInvalidateToken(t,e),await this.changeCurrentUser(null)}createAuthorizationURL({clientName:e,redirectURL:t}){let{apiURI:r,appId:n}=this.config;return`${r}/runtime/oauth/start?app_id=${n}&client_name=${e}&redirect_uri=${t}`}async exchangeCodeForToken({code:e,codeVerifier:t}){let r=await this.getCurrentUser(),n=r?.user?.type==="guest",s=await tP({apiURI:this.config.apiURI,appId:this.config.appId,code:e,codeVerifier:t,refreshToken:n?r.user.refresh_token:void 0});return await this.changeCurrentUser(s.user),s}issuerURI(){let{apiURI:e,appId:t}=this.config;return`${e}/runtime/${t}`}async signInWithIdToken({idToken:e,clientName:t,nonce:r}){let n=await this.getCurrentUser(),s=n?.user?.refresh_token,i=await tj({apiURI:this.config.apiURI,appId:this.config.appId,idToken:e,clientName:t,nonce:r,refreshToken:s});return await this.changeCurrentUser(i.user),i}joinRoom(e,t,r){let n=!1;this._rooms[t]||(n=!0,this._rooms[t]={roomType:e,isConnected:!1,error:void 0}),this._presence[t]=this._presence[t]||{};let s=this._presence[t].result;return r&&!s&&(this._presence[t].result=this._presence[t].result||{},this._presence[t].result.user=r,this._notifyPresenceSubs(t)),n&&this._tryJoinRoom(e,t,r),()=>{this._cleanupRoom(t)}}_cleanupRoom(e){if(!this._presence[e]?.handlers?.length&&!Object.keys(this._broadcastSubs[e]??{}).length){let t=this._rooms[e]?.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],t?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,t,r={}){let n=this._rooms[t],s=this._presence[t];return n&&s&&s.result?{...function(e,t,r){let n={peers:{}};for(let s of(t&&"user"in t&&!t.user||(n.user={...tW(e.user??{},t?.keys),peerId:r}),Object.keys(e.peers??{}))){let r=t?.peers===void 0,i=Array.isArray(t?.peers)&&t?.peers.includes(s);if(r||i){let r=tW(e.peers[s],t?.keys);n.peers[s]={...r,peerId:s}}}return n}(s.result,r,this._sessionId),isLoading:!n.isConnected,error:n.error}:null}publishPresence(e,t,r){let n=this._rooms[t],s=this._presence[t];if(!n||!s)return;s.result=s.result||{};let i={...s.result.user,...r};s.result.user=i,n.isConnected&&(this._trySetPresence(t,i),this._notifyPresenceSubs(t))}_trySetPresence(e,t){this._trySendAuthed(eF(),{op:"set-presence","room-id":e,data:t})}_tryJoinRoom(e,t,r){this._trySendAuthed(eF(),{op:"join-room","room-type":e,"room-id":t,data:r}),delete this._roomsPendingLeave[t]}_tryLeaveRoom(e){this._trySendAuthed(eF(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,t){let r=this._rooms[e];r&&(r.isConnected=t)}subscribePresence(e,t,r,n){let s=this.joinRoom(e,t,r.initialPresence||r.initialData),i={...r,roomId:t,cb:n,prev:null};return this._presence[t]=this._presence[t]||{},this._presence[t].handlers=this._presence[t].handlers||[],this._presence[t].handlers.push(i),this._notifyPresenceSub(t,i),()=>{this._presence[t].handlers=this._presence[t]?.handlers?.filter(e=>e!==i)??[],s()}}_notifyPresenceSubs(e){this._presence[e]?.handlers?.forEach(t=>{this._notifyPresenceSub(e,t)})}_notifyPresenceSub(e,t){let r=this.getPresence("",e,t);!r||(!t.prev||function(e,t){if(e.isLoading!==t.isLoading||e.error!==t.error||(e.user||t.user)&&(!e.user||!t.user||!H(e.user,t.user))||!J(e.peers,t.peers))return!0;for(let r of Object.keys(e.peers))if(!H(e.peers[r],t.peers[r]))return!0;return!1}(r,t.prev))&&(t.prev=r,t.cb(r))}_patchPresencePeers(e,t){let r=Object.fromEntries(Object.entries(this._presence[e]?.result?.peers||{}).map(([e,t])=>[e,{data:t}]));this._presence[e]?.result;let n=B(r,e=>{for(let[r,n,s]of t)switch(n){case"+":!function(e,t,r){if(!e||0===t.length)return;let n=e||{};for(let e=0;e<t.length-1;e++){let r=t[e];r in n&&"object"==typeof n[r]||(n[r]="number"==typeof t[e+1]?[]:{}),n=n[r]}let s=t[t.length-1];Array.isArray(n)&&"number"==typeof s?n.splice(s,0,r):n[s]=r}(e,r,s);break;case"r":ee(e,r,s);break;case"-":!function e(t,r){if(!t||0===r.length)return;let[n,...s]=r;if(n in t){var i;if(0===s.length)return void(Array.isArray(t)?t.splice(n,1):delete t[n]);e(t[n],s),(i=t[n])&&0===Object.keys(i).length&&delete t[n]}}(e,r)}delete e[this._sessionId]});this._setPresencePeers(e,n)}_setPresencePeers(e,t){let r={...t};delete r[this._sessionId];let n=Object.fromEntries(Object.entries(r).map(([e,t])=>[e,t.data]));this._presence=B(this._presence,t=>{ee(t,[e,"result","peers"],n)})}publishTopic({roomType:e,roomId:t,topic:r,data:n}){let s=this._rooms[t];if(s){if(!s.isConnected){this._broadcastQueue[t]=this._broadcastQueue[t]??[],this._broadcastQueue[t].push({topic:r,roomType:e,data:n});return}this._tryBroadcast(t,e,r,n)}}_tryBroadcast(e,t,r,n){this._trySendAuthed(eF(),{op:"client-broadcast","room-id":e,roomType:t,topic:r,data:n})}subscribeTopic(e,t,r,n){let s=this.joinRoom(e,t);return this._broadcastSubs[t]=this._broadcastSubs[t]||{},this._broadcastSubs[t][r]=this._broadcastSubs[t][r]||[],this._broadcastSubs[t][r].push(n),this._presence[t]=this._presence[t]||{},()=>{this._broadcastSubs[t][r]=this._broadcastSubs[t][r].filter(e=>e!==n),this._broadcastSubs[t][r].length||delete this._broadcastSubs[t][r],s()}}_notifyBroadcastSubs(e,t,r){this._broadcastSubs?.[e]?.[t]?.forEach(t=>t(r.data?.data,r.data["peer-id"]===this._sessionId?this._presence[e]?.result?.user:this._presence[e]?.result?.peers?.[r.data["peer-id"]]))}async uploadFile(e,t,r){let n=await this.getCurrentUser(),s=n?.user?.refresh_token;return tD({...r,apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:t,refreshToken:s})}async deleteFile(e){let t=await this.getCurrentUser(),r=t?.user?.refresh_token;return await tU({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}async upload(e,t){let r=await this.getCurrentUser(),n=r?.user?.refresh_token,s=e||t.name,i=await tR({apiURI:this.config.apiURI,appId:this.config.appId,fileName:s,refreshToken:n});return await tN(i,t)}async getDownloadUrl(e){let t=await this.getCurrentUser(),r=t?.user?.refresh_token;return await tL({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}}let rM=function(e){return new tJ(e,{})},rx=function(){return new tB("string",!0,!1)},rP=("u"<typeof window,{apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"});function rj(e){let t=e.__adminToken;return e.appId+"_"+(e.websocketURI||"default_ws_uri")+"_"+(e.apiURI||"default_api_uri")+"_"+(t||"client_only")+"_"+e.useDateObjects}let r$=(globalThis.__instantDbStore=globalThis.__instantDbStore??{},globalThis.__instantDbStore),rD=(globalThis.__instantDbSchemaHashStore=globalThis.__instantDbSchemaHashStore??new WeakMap,globalThis.__instantDbSchemaHashStore);class rU{db;constructor(e){this.db=e}sendMagicCode=e=>this.db.sendMagicCode(e);signInWithMagicCode=e=>this.db.signInWithMagicCode(e);signInWithToken=e=>this.db.signInWithCustomToken(e);signInAsGuest=()=>this.db.signInAsGuest();createAuthorizationURL=e=>this.db.createAuthorizationURL(e);signInWithIdToken=e=>this.db.signInWithIdToken(e);exchangeOAuthCode=e=>this.db.exchangeCodeForToken(e);issuerURI=()=>this.db.issuerURI();signOut=(e={invalidateToken:!0})=>this.db.signOut(e)}class rR{db;constructor(e){this.db=e}uploadFile=(e,t,r={})=>this.db.uploadFile(e,t,r);delete=e=>this.db.deleteFile(e);upload=(e,t)=>this.db.upload(e,t);put=this.upload;getDownloadUrl=e=>this.db.getDownloadUrl(e)}class rN{db;constructor(e){this.db=e}createReadStream=e=>this.db.createReadStream(e);createWriteStream=e=>this.db.createWriteStream(e)}class rL{_reactor;auth;storage;streams;tx=e7();constructor(e){this._reactor=e,this.auth=new rU(this._reactor),this.storage=new rR(this._reactor),this.streams=new rN(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,t,r){return this._reactor.subscribeQuery(e,t,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",t="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(e,t,r?.initialPresence),subscribeTopic:(r,n)=>this._reactor.subscribeTopic(e,t,r,n),subscribePresence:(r,n)=>this._reactor.subscribePresence(e,t,r,n),publishTopic:(r,n)=>this._reactor.publishTopic({roomType:e,roomId:t,topic:r,data:n}),publishPresence:r=>this._reactor.publishPresence(e,t,r),getPresence:r=>this._reactor.getPresence(e,t,r)}}shutdown(){delete r$[rj(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,t){return this._reactor.queryOnce(e,t)}_syncTableExperimental(e,t){return this._reactor.subscribeTable(e,t)}}function rF(e){if(!e)return"0";let t=rD.get(e);if(t)return t;let r=n(e);return rD.set(e,r),r}e.s(["id",0,eF],2909);var rK,rq=e.i(43476),rW=e.i(71645);let rz={isLoading:!0,data:void 0,pageInfo:void 0,error:void 0};function rV(e){return{isLoading:!e,data:void 0,pageInfo:void 0,error:void 0,...e||{}}}let rQ={useTopicEffect:function(e,t,r){let n=(0,rW.useRef)(r);n.current=r,(0,rW.useEffect)(()=>e.core._reactor.subscribeTopic(e.type,e.id,t,(e,t)=>{n.current(e,t)}),[e.id,t])},usePublishTopic:function(e,t){return(0,rW.useEffect)(()=>e.core._reactor.joinRoom(e.type,e.id),[e.id]),(0,rW.useCallback)(r=>{e.core._reactor.publishTopic({roomType:e.type,roomId:e.id,topic:t,data:r})},[e.id,t])},usePresence:function(e,t={}){let[r,n]=(0,rW.useState)(()=>e.core._reactor.getPresence(e.type,e.id,t)??{peers:{},isLoading:!0});(0,rW.useEffect)(()=>e.core._reactor.subscribePresence(e.type,e.id,t,e=>{n(e)}),[e.id,t.user,t.peers?.join(),t.keys?.join()]);let s=(0,rW.useCallback)(t=>{e.core._reactor.publishPresence(e.type,e.id,t)},[e.type,e.id]);return(0,rW.useMemo)(()=>({...r,publishPresence:s}),[r,s])},useSyncPresence:function(e,t,r){(0,rW.useEffect)(()=>e.core._reactor.joinRoom(e.type,e.id,t),[e.id]),(0,rW.useEffect)(()=>e.core._reactor.publishPresence(e.type,e.id,t),[e.type,e.id,r??JSON.stringify(t)])},useTypingIndicator:function(e,t,r={}){let n=function(){let e=(0,rW.useRef)(null);function t(){e.current&&clearTimeout(e.current)}return(0,rW.useEffect)(()=>{t()},[]),{set:function(r,n){t(),e.current=setTimeout(n,r)},clear:t}}(),s=rQ.usePresence(e,{keys:[t]}),i=(0,rW.useMemo)(()=>{let n=e._core._reactor.getPresence(e.type,e.id);return r?.writeOnly?[]:Object.values(n?.peers??{}).filter(e=>!0===e[t])},[r?.writeOnly,s]),o=(0,rW.useCallback)(s=>{e.core._reactor.publishPresence(e.type,e.id,{[t]:s}),s&&r?.timeout!==null&&r?.timeout!==0&&n.set(r?.timeout??1e3,()=>{e.core._reactor.publishPresence(e.type,e.id,{[t]:null})})},[e.type,e.id,t,r?.timeout,n]),a=(0,rW.useCallback)(e=>{o(!(r?.stopOnEnter&&"Enter"===e.key))},[r.stopOnEnter,o]),l=(0,rW.useCallback)(()=>{o(!1)},[o]);return{active:i,setActive:o,inputProps:(0,rW.useMemo)(()=>({onKeyDown:a,onBlur:l}),[a,l])}}};class rG{core;_core;type;id;constructor(e,t,r){this.core=e,this._core=this.core,this.type=t,this.id=r}useTopicEffect=(e,t)=>{rQ.useTopicEffect(this,e,t)};usePublishTopic=e=>rQ.usePublishTopic(this,e);usePresence=(e={})=>rQ.usePresence(this,e);useSyncPresence=(e,t)=>rQ.useSyncPresence(this,e,t);useTypingIndicator=(e,t={})=>rQ.useTypingIndicator(this,e,t)}let rB={isLoading:!0,user:void 0,error:void 0};class rJ{tx=e7();auth;storage;streams;core;_core;static Store;static NetworkListener;static EventSourceImpl;constructor(e,t){this.core=function(e,t,n,s,i){let o={...e,appId:e.appId?.trim(),useDateObjects:e.useDateObjects??!1},a=r$[rj(o)];if(a){var l;return l=o.schema,rF(a._reactor.config.schema)!==rF(l)&&a._reactor.updateSchema(o.schema),a}let u=new rL(new rC({...rP,...o,cardinalityInference:!!o.schema},t||tk,n||tO,{...s||{},"@instantdb/core":tG},i));return r$[rj(o)]=u,function(e,t){if("u"<typeof window||void 0===window.location||"u"<typeof document||"boolean"==typeof t&&!t)return;let n={position:"bottom-right",allowedHosts:["localhost"],..."object"==typeof t?t:{}};n.allowedHosts.includes(window.location.hostname)&&function(e,t){var n,s,i,o,a;let l,u,c,h,d;r?.dispose();let f=(n=t,Object.assign((l=document.createElement("div")).style,{position:"fixed",...function(e){switch(e){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}(n.position),display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"}),l.style.display="none",l.className="instant-devtool-container",{element:l,isVisible:function(){return"none"!==l.style.display}}),p=(s=t,i=m,u=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,(c=document.createElement("button")).innerHTML=u,c.className="instant-devtool-toggler",Object.assign(c.style,{position:"fixed",...function(e){switch(e){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}(s.position),height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"}),c.addEventListener("click",i),{element:c}),y=(a=(o=e,h=tF||tq,`${h?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${o}`),(d=document.createElement("iframe")).src=a,d.className="instant-devtool-iframe",Object.assign(d.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:d});function g(e){e.source===y.element.contentWindow&&e.data?.type==="close"&&f.isVisible()&&m()}function b(e){let t=e.shiftKey&&e.ctrlKey&&"0"===e.key,r="Escape"===e.key||"Esc"===e.key;t?m():r&&f.isVisible()&&m()}function m(){f.isVisible()?f.element.style.display="none":(f.element.style.display="block",f.element.contains(y.element)||f.element.appendChild(y.element))}document.body.appendChild(f.element),document.body.appendChild(p.element),addEventListener("keydown",b),addEventListener("message",g),r={dispose:function(){f.element.remove(),p.element.remove(),removeEventListener("keydown",b),removeEventListener("message",g)}}}(e,n)}(o.appId,o.devtool),u}(e,e.Store||this.constructor.Store,this.constructor.NetworkListener,t,this.constructor.EventSourceImpl),this._core=this.core,this.auth=this.core.auth,this.storage=this.core.storage,this.streams=this.core.streams}getLocalId=e=>this.core.getLocalId(e);useLocalId=e=>{let[t,r]=(0,rW.useState)(null);return(0,rW.useEffect)(()=>{(async()=>{r(await this.getLocalId(e))})()},[e]),t};room(e="_defaultRoomType",t="_defaultRoomId"){return new rG(this.core,e,t)}rooms=rQ;transact=e=>this.core.transact(e);useQuery=(e,t)=>{var r,s;let i,o,a,l;return(r=this.core,(s=e)&&t&&"ruleParams"in t&&(s={$$ruleParams:t.ruleParams,...s}),o=n(i=s?JSON.parse(JSON.stringify(s)):null),a=(0,rW.useRef)(rV(r._reactor.getPreviousResult(i))),l=(0,rW.useCallback)(e=>(a.current=rV(r._reactor.getPreviousResult(i)),e(),i)?r.subscribeQuery(i,t=>{a.current={isLoading:!t,data:void 0,pageInfo:void 0,error:void 0,...t},e()}):()=>{},[o]),{state:(0,rW.useSyncExternalStore)(l,()=>a.current,()=>rz),query:i}).state};useAuth=()=>this._useAuth();_useAuth(){let e=(0,rW.useRef)(this.core._reactor._currentUserCached),t=(0,rW.useCallback)(t=>this.core.subscribeAuth(r=>{e.current={isLoading:!1,...r},t()}),[]);return(0,rW.useSyncExternalStore)(t,()=>e.current,()=>rB)}useUser=()=>{let{user:e}=this.useAuth();if(!e)throw new tE("useUser must be used within an auth-protected route");return e};getAuth(){return this.core.getAuth()}useConnectionStatus=()=>{let e=(0,rW.useRef)(this.core._reactor.status),t=(0,rW.useCallback)(t=>this.core.subscribeConnectionStatus(r=>{r!==e.current&&(e.current=r,t())}),[]);return(0,rW.useSyncExternalStore)(t,()=>e.current,()=>"connecting")};queryOnce=(e,t)=>this.core.queryOnce(e,t);SignedIn=({children:e})=>{let t=this.useAuth();return t.isLoading||t.error||!t.user?null:(0,rq.jsx)(rq.Fragment,{children:e})};SignedOut=({children:e})=>{let t=this.useAuth();return t.isLoading||t.error||t.user?null:(0,rq.jsx)(rq.Fragment,{children:e})}}class rH extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function rZ(e){}class rY extends Event{constructor(e,t){var r,n;super(e),this.code=null!=(r=null==t?void 0:t.code)?r:void 0,this.message=null!=(n=null==t?void 0:t.message)?n:void 0}[Symbol.for("nodejs.util.inspect.custom")](e,t,r){return r(rX(this),t)}[Symbol.for("Deno.customInspect")](e,t){return e(rX(this),t)}}function rX(e){return{type:e.type,message:e.message,code:e.code,defaultPrevented:e.defaultPrevented,cancelable:e.cancelable,timeStamp:e.timeStamp}}var r0,r1,r2,r3,r4,r6,r8,r9,r5,r7,ne,nt,nr,nn,ns,ni,no,na,nl,nu,nc,nh,nd,nf,np,ny=e=>{throw TypeError(e)},ng=(e,t,r)=>t.has(e)||ny("Cannot "+r),nb=(e,t,r)=>(ng(e,t,"read from private field"),r?r.call(e):t.get(e)),nm=(e,t,r)=>t.has(e)?ny("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),nv=(e,t,r,n)=>(ng(e,t,"write to private field"),t.set(e,r),r),n_=(e,t,r)=>(ng(e,t,"access private method"),r);class nw extends EventTarget{constructor(e,t){var r,n;super(),nm(this,ni),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,nm(this,r2),nm(this,r3),nm(this,r4),nm(this,r6),nm(this,r8),nm(this,r9),nm(this,r5),nm(this,r7,null),nm(this,ne),nm(this,nt),nm(this,nr,null),nm(this,nn,null),nm(this,ns,null),nm(this,na,async e=>{var t;nb(this,nt).reset();let{body:r,redirected:n,status:s,headers:i}=e;if(204===s){n_(this,ni,nd).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(n?nv(this,r4,new URL(e.url)):nv(this,r4,void 0),200!==s)return void n_(this,ni,nd).call(this,`Non-200 status code (${s})`,s);if(!(i.get("content-type")||"").startsWith("text/event-stream"))return void n_(this,ni,nd).call(this,'Invalid content type, expected "text/event-stream"',s);if(nb(this,r2)===this.CLOSED)return;nv(this,r2,this.OPEN);let o=new Event("open");if(null==(t=nb(this,ns))||t.call(this,o),this.dispatchEvent(o),"object"!=typeof r||!r||!("getReader"in r)){n_(this,ni,nd).call(this,"Invalid response body, expected a web ReadableStream",s),this.close();return}let a=new TextDecoder,l=r.getReader(),u=!0;do{let{done:e,value:t}=await l.read();t&&nb(this,nt).feed(a.decode(t,{stream:!e})),e&&(u=!1,nb(this,nt).reset(),n_(this,ni,nf).call(this))}while(u)}),nm(this,nl,e=>{nv(this,ne,void 0),"AbortError"!==e.name&&"aborted"!==e.type&&n_(this,ni,nf).call(this,function e(t){return t instanceof Error?"errors"in t&&Array.isArray(t.errors)?t.errors.map(e).join(", "):"cause"in t&&t.cause instanceof Error?`${t}: ${e(t.cause)}`:t.message:`${t}`}(e))}),nm(this,nc,e=>{"string"==typeof e.id&&nv(this,r7,e.id);let t=new MessageEvent(e.event||"message",{data:e.data,origin:nb(this,r4)?nb(this,r4).origin:nb(this,r3).origin,lastEventId:e.id||""});nb(this,nn)&&(!e.event||"message"===e.event)&&nb(this,nn).call(this,t),this.dispatchEvent(t)}),nm(this,nh,e=>{nv(this,r9,e)}),nm(this,np,()=>{nv(this,r5,void 0),nb(this,r2)===this.CONNECTING&&n_(this,ni,no).call(this)});try{if(e instanceof URL)nv(this,r3,e);else if("string"==typeof e)nv(this,r3,new URL(e,function(){let e="document"in globalThis?globalThis.document:void 0;return e&&"object"==typeof e&&"baseURI"in e&&"string"==typeof e.baseURI?e.baseURI:void 0}()));else throw Error("Invalid URL")}catch{throw function(e){let t=globalThis.DOMException;return"function"==typeof t?new t(e,"SyntaxError"):SyntaxError(e)}("An invalid or illegal string was specified")}nv(this,nt,function(e){if("function"==typeof e)throw TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=rZ,onError:r=rZ,onRetry:n=rZ,onComment:s}=e,i="",o=!0,a,l="",u="";function c(e){if(""===e)return void(l.length>0&&t({id:a,event:u||void 0,data:l.endsWith(`
`)?l.slice(0,-1):l}),a=void 0,l="",u="");if(e.startsWith(":")){s&&s(e.slice(e.startsWith(": ")?2:1));return}let r=e.indexOf(":");if(-1!==r){let t=e.slice(0,r),n=" "===e[r+1]?2:1;h(t,e.slice(r+n),e);return}h(e,"",e)}function h(e,t,s){switch(e){case"event":u=t;break;case"data":l=`${l}${t}
`;break;case"id":a=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?n(parseInt(t,10)):r(new rH(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:s}));break;default:r(new rH(`Unknown field "${e.length>20?`${e.slice(0,20)}\u2026`:e}"`,{type:"unknown-field",field:e,value:t,line:s}))}}return{feed:function(e){let t=o?e.replace(/^\xEF\xBB\xBF/,""):e,[r,n]=function(e){let t=[],r="",n=0;for(;n<e.length;){let s=e.indexOf("\r",n),i=e.indexOf(`
`,n),o=-1;if(-1!==s&&-1!==i?o=Math.min(s,i):-1!==s?o=s===e.length-1?-1:s:-1!==i&&(o=i),-1===o){r=e.slice(n);break}{let r=e.slice(n,o);t.push(r),"\r"===e[(n=o+1)-1]&&e[n]===`
`&&n++}}return[t,r]}(`${i}${t}`);for(let e of r)c(e);i=n,o=!1},reset:function(e={}){i&&e.consume&&c(i),o=!0,a=void 0,l="",u="",i=""}}}({onEvent:nb(this,nc),onRetry:nb(this,nh)})),nv(this,r2,this.CONNECTING),nv(this,r9,3e3),nv(this,r8,null!=(r=null==t?void 0:t.fetch)?r:globalThis.fetch),nv(this,r6,null!=(n=null==t?void 0:t.withCredentials)&&n),n_(this,ni,no).call(this)}get readyState(){return nb(this,r2)}get url(){return nb(this,r3).href}get withCredentials(){return nb(this,r6)}get onerror(){return nb(this,nr)}set onerror(e){nv(this,nr,e)}get onmessage(){return nb(this,nn)}set onmessage(e){nv(this,nn,e)}get onopen(){return nb(this,ns)}set onopen(e){nv(this,ns,e)}addEventListener(e,t,r){super.addEventListener(e,t,r)}removeEventListener(e,t,r){super.removeEventListener(e,t,r)}close(){nb(this,r5)&&clearTimeout(nb(this,r5)),nb(this,r2)!==this.CLOSED&&(nb(this,ne)&&nb(this,ne).abort(),nv(this,r2,this.CLOSED),nv(this,ne,void 0))}}r2=new WeakMap,r3=new WeakMap,r4=new WeakMap,r6=new WeakMap,r8=new WeakMap,r9=new WeakMap,r5=new WeakMap,r7=new WeakMap,ne=new WeakMap,nt=new WeakMap,nr=new WeakMap,nn=new WeakMap,ns=new WeakMap,ni=new WeakSet,no=function(){nv(this,r2,this.CONNECTING),nv(this,ne,new AbortController),nb(this,r8)(nb(this,r3),n_(this,ni,nu).call(this)).then(nb(this,na)).catch(nb(this,nl))},na=new WeakMap,nl=new WeakMap,nu=function(){var e;let t={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...nb(this,r7)?{"Last-Event-ID":nb(this,r7)}:void 0},cache:"no-store",signal:null==(e=nb(this,ne))?void 0:e.signal};return"window"in globalThis&&(t.credentials=this.withCredentials?"include":"same-origin"),t},nc=new WeakMap,nh=new WeakMap,nd=function(e,t){var r;nb(this,r2)!==this.CLOSED&&nv(this,r2,this.CLOSED);let n=new rY("error",{code:t,message:e});null==(r=nb(this,nr))||r.call(this,n),this.dispatchEvent(n)},nf=function(e,t){var r;if(nb(this,r2)===this.CLOSED)return;nv(this,r2,this.CONNECTING);let n=new rY("error",{code:t,message:e});null==(r=nb(this,nr))||r.call(this,n),this.dispatchEvent(n),nv(this,r5,setTimeout(nb(this,np),nb(this,r9)))},np=new WeakMap,nw.CONNECTING=0,nw.OPEN=1,nw.CLOSED=2,Object.defineProperty(nw,Symbol.for("eventsource.supports-fetch-override"),{value:!0,writable:!1,configurable:!1,enumerable:!1});e.s([],50766);let nS=function({entities:e,links:t,rooms:r}){let n=t??{};return new tH(function(e,t){let r={},n={};for(let e of Object.values(t))r[e.forward.on]||={},n[e.reverse.on]||={},r[e.forward.on][e.forward.label]={entityName:e.reverse.on,cardinality:e.forward.has},n[e.reverse.on][e.reverse.label]={entityName:e.forward.on,cardinality:e.reverse.has};return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,new tJ(t.attrs,{...r[e],...n[e]})]))}(e,n),n,r??{})}({entities:{$files:rM({path:rx().unique().indexed(),url:rx()}),$users:rM({email:rx().unique().indexed().optional()}),memes:rM({createdAt:new tB("date",!0,!1)}),upvotes:rM({})},links:{memeImage:{forward:{on:"memes",has:"one",label:"image"},reverse:{on:"$files",has:"many",label:"memes"}},memeAuthor:{forward:{on:"memes",has:"one",label:"author"},reverse:{on:"$users",has:"many",label:"memes"}},upvoteMeme:{forward:{on:"upvotes",has:"one",label:"meme"},reverse:{on:"memes",has:"many",label:"upvotes"}},upvoteUser:{forward:{on:"upvotes",has:"one",label:"$user"},reverse:{on:"$users",has:"many",label:"upvotes"}}},rooms:{}}),nT=new class e extends rJ{static EventSourceImpl=nw}({...rK={appId:"9c63eab6-a43a-42ae-b6a0-d401cc2082ba",schema:nS,useDateObjects:!0},useDateObjects:rK.useDateObjects??!1},{"@instantdb/react":tG});e.s(["db",0,nT],8896)},86608,e=>{"use strict";var t=e.i(43476),r=e.i(71645),n=e.i(8896);function s(){let[e,s]=(0,r.useState)(""),[i,o]=(0,r.useState)(""),a=(0,r.useRef)(null),l=(0,r.useRef)(null);return e?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center p-4",children:(0,t.jsxs)("div",{className:"w-full max-w-sm",children:[(0,t.jsx)("h1",{className:"text-xl font-semibold text-[var(--text)] mb-2",children:"Enter code"}),(0,t.jsxs)("p",{className:"text-sm text-[var(--muted)] mb-4",children:["We sent a 6-digit code to ",(0,t.jsx)("strong",{className:"text-[var(--text)]",children:e}),". Enter it below."]}),(0,t.jsxs)("form",{className:"flex flex-col gap-3",onSubmit:t=>{t.preventDefault();let r=l.current?.value?.trim();r&&(o(""),n.db.auth.signInWithMagicCode({email:e,code:r}).catch(e=>{o(e?.body?.message??"Invalid code"),l.current&&(l.current.value="")}))},children:[(0,t.jsx)("input",{ref:l,type:"text",inputMode:"numeric",autoComplete:"one-time-code",placeholder:"123456",maxLength:6,required:!0,autoFocus:!0,className:"w-full px-3 py-2 rounded-lg border border-[var(--border)] bg-[var(--surface)] text-[var(--text)] placeholder:text-[var(--muted)] focus:outline-none focus:border-[var(--accent)] text-center tracking-[0.5em] font-mono text-lg"}),i&&(0,t.jsx)("p",{className:"text-sm text-red-400",children:i}),(0,t.jsx)("button",{type:"submit",className:"w-full py-2 rounded-lg bg-[var(--accent)] text-black font-medium hover:bg-[var(--accent-hover)] transition-colors",children:"Verify"}),(0,t.jsx)("button",{type:"button",className:"w-full py-2 text-sm text-[var(--muted)] hover:text-[var(--text)]",onClick:()=>s(""),children:"Use a different email"})]})]})}):(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center p-4",children:(0,t.jsxs)("div",{className:"w-full max-w-sm",children:[(0,t.jsx)("h1",{className:"text-xl font-semibold text-[var(--text)] mb-2",children:"Sign in"}),(0,t.jsx)("p",{className:"text-sm text-[var(--muted)] mb-4",children:"Enter your email and we will send you a 6-digit code to sign in."}),(0,t.jsxs)("form",{className:"flex flex-col gap-3",onSubmit:e=>{e.preventDefault();let t=a.current?.value?.trim();t&&(o(""),s(t),n.db.auth.sendMagicCode({email:t}).catch(e=>{o(e?.body?.message??"Failed to send code"),s("")}))},children:[(0,t.jsx)("input",{ref:a,type:"email",placeholder:"you@example.com",required:!0,autoFocus:!0,className:"w-full px-3 py-2 rounded-lg border border-[var(--border)] bg-[var(--surface)] text-[var(--text)] placeholder:text-[var(--muted)] focus:outline-none focus:border-[var(--accent)]"}),i&&(0,t.jsx)("p",{className:"text-sm text-red-400",children:i}),(0,t.jsx)("button",{type:"submit",className:"w-full py-2 rounded-lg bg-[var(--accent)] text-black font-medium hover:bg-[var(--accent-hover)] transition-colors",children:"Send code"})]})]})})}e.s(["Login",()=>s])},98183,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n={assign:function(){return l},searchParamsToUrlQuery:function(){return i},urlQueryToSearchParams:function(){return a}};for(var s in n)Object.defineProperty(r,s,{enumerable:!0,get:n[s]});function i(e){let t={};for(let[r,n]of e.entries()){let e=t[r];void 0===e?t[r]=n:Array.isArray(e)?e.push(n):t[r]=[e,n]}return t}function o(e){return"string"==typeof e?e:("number"!=typeof e||isNaN(e))&&"boolean"!=typeof e?"":String(e)}function a(e){let t=new URLSearchParams;for(let[r,n]of Object.entries(e))if(Array.isArray(n))for(let e of n)t.append(r,o(e));else t.set(r,o(n));return t}function l(e,...t){for(let r of t){for(let t of r.keys())e.delete(t);for(let[t,n]of r.entries())e.append(t,n)}return e}},95057,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n={formatUrl:function(){return a},formatWithValidation:function(){return u},urlObjectKeys:function(){return l}};for(var s in n)Object.defineProperty(r,s,{enumerable:!0,get:n[s]});let i=e.r(90809)._(e.r(98183)),o=/https?|ftp|gopher|file/;function a(e){let{auth:t,hostname:r}=e,n=e.protocol||"",s=e.pathname||"",a=e.hash||"",l=e.query||"",u=!1;t=t?encodeURIComponent(t).replace(/%3A/i,":")+"@":"",e.host?u=t+e.host:r&&(u=t+(~r.indexOf(":")?`[${r}]`:r),e.port&&(u+=":"+e.port)),l&&"object"==typeof l&&(l=String(i.urlQueryToSearchParams(l)));let c=e.search||l&&`?${l}`||"";return n&&!n.endsWith(":")&&(n+=":"),e.slashes||(!n||o.test(n))&&!1!==u?(u="//"+(u||""),s&&"/"!==s[0]&&(s="/"+s)):u||(u=""),a&&"#"!==a[0]&&(a="#"+a),c&&"?"!==c[0]&&(c="?"+c),s=s.replace(/[?#]/g,encodeURIComponent),c=c.replace("#","%23"),`${n}${u}${s}${c}${a}`}let l=["auth","hash","host","hostname","href","path","pathname","port","protocol","query","search","slashes"];function u(e){return a(e)}},18581,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"useMergedRef",{enumerable:!0,get:function(){return s}});let n=e.r(71645);function s(e,t){let r=(0,n.useRef)(null),s=(0,n.useRef)(null);return(0,n.useCallback)(n=>{if(null===n){let e=r.current;e&&(r.current=null,e());let t=s.current;t&&(s.current=null,t())}else e&&(r.current=i(e,n)),t&&(s.current=i(t,n))},[e,t])}function i(e,t){if("function"!=typeof e)return e.current=t,()=>{e.current=null};{let r=e(t);return"function"==typeof r?r:()=>e(null)}}("function"==typeof r.default||"object"==typeof r.default&&null!==r.default)&&void 0===r.default.__esModule&&(Object.defineProperty(r.default,"__esModule",{value:!0}),Object.assign(r.default,r),t.exports=r.default)},18967,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n={DecodeError:function(){return b},MiddlewareNotFoundError:function(){return w},MissingStaticPage:function(){return _},NormalizeError:function(){return m},PageNotFoundError:function(){return v},SP:function(){return y},ST:function(){return g},WEB_VITALS:function(){return i},execOnce:function(){return o},getDisplayName:function(){return h},getLocationOrigin:function(){return u},getURL:function(){return c},isAbsoluteUrl:function(){return l},isResSent:function(){return d},loadGetInitialProps:function(){return p},normalizeRepeatedSlashes:function(){return f},stringifyError:function(){return S}};for(var s in n)Object.defineProperty(r,s,{enumerable:!0,get:n[s]});let i=["CLS","FCP","FID","INP","LCP","TTFB"];function o(e){let t,r=!1;return(...n)=>(r||(r=!0,t=e(...n)),t)}let a=/^[a-zA-Z][a-zA-Z\d+\-.]*?:/,l=e=>a.test(e);function u(){let{protocol:e,hostname:t,port:r}=window.location;return`${e}//${t}${r?":"+r:""}`}function c(){let{href:e}=window.location,t=u();return e.substring(t.length)}function h(e){return"string"==typeof e?e:e.displayName||e.name||"Unknown"}function d(e){return e.finished||e.headersSent}function f(e){let t=e.split("?");return t[0].replace(/\\/g,"/").replace(/\/\/+/g,"/")+(t[1]?`?${t.slice(1).join("?")}`:"")}async function p(e,t){let r=t.res||t.ctx&&t.ctx.res;if(!e.getInitialProps)return t.ctx&&t.Component?{pageProps:await p(t.Component,t.ctx)}:{};let n=await e.getInitialProps(t);if(r&&d(r))return n;if(!n)throw Object.defineProperty(Error(`"${h(e)}.getInitialProps()" should resolve to an object. But found "${n}" instead.`),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return n}let y="u">typeof performance,g=y&&["mark","measure","getEntriesByName"].every(e=>"function"==typeof performance[e]);class b extends Error{}class m extends Error{}class v extends Error{constructor(e){super(),this.code="ENOENT",this.name="PageNotFoundError",this.message=`Cannot find module for page: ${e}`}}class _ extends Error{constructor(e,t){super(),this.message=`Failed to load static file for page: ${e} ${t}`}}class w extends Error{constructor(){super(),this.code="ENOENT",this.message="Cannot find the middleware module"}}function S(e){return JSON.stringify({message:e.message,stack:e.stack})}},73668,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"isLocalURL",{enumerable:!0,get:function(){return i}});let n=e.r(18967),s=e.r(52817);function i(e){if(!(0,n.isAbsoluteUrl)(e))return!0;try{let t=(0,n.getLocationOrigin)(),r=new URL(e,t);return r.origin===t&&(0,s.hasBasePath)(r.pathname)}catch(e){return!1}}},84508,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"errorOnce",{enumerable:!0,get:function(){return n}});let n=e=>{}},22016,(e,t,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n={default:function(){return b},useLinkStatus:function(){return v}};for(var s in n)Object.defineProperty(r,s,{enumerable:!0,get:n[s]});let i=e.r(90809),o=e.r(43476),a=i._(e.r(71645)),l=e.r(95057),u=e.r(8372),c=e.r(18581),h=e.r(18967),d=e.r(5550);e.r(33525);let f=e.r(91949),p=e.r(73668),y=e.r(9396);function g(e){return"string"==typeof e?e:(0,l.formatUrl)(e)}function b(t){var r;let n,s,i,[l,b]=(0,a.useOptimistic)(f.IDLE_LINK_STATUS),v=(0,a.useRef)(null),{href:_,as:w,children:S,prefetch:T=null,passHref:k,replace:O,shallow:E,scroll:A,onClick:I,onMouseEnter:C,onTouchStart:M,legacyBehavior:x=!1,onNavigate:P,ref:j,unstable_dynamicOnHover:$,...D}=t;n=S,x&&("string"==typeof n||"number"==typeof n)&&(n=(0,o.jsx)("a",{children:n}));let U=a.default.useContext(u.AppRouterContext),R=!1!==T,N=!1!==T?null===(r=T)||"auto"===r?y.FetchStrategy.PPR:y.FetchStrategy.Full:y.FetchStrategy.PPR,{href:L,as:F}=a.default.useMemo(()=>{let e=g(_);return{href:e,as:w?g(w):e}},[_,w]);if(x){if(n?.$$typeof===Symbol.for("react.lazy"))throw Object.defineProperty(Error("`<Link legacyBehavior>` received a direct child that is either a Server Component, or JSX that was loaded with React.lazy(). This is not supported. Either remove legacyBehavior, or make the direct child a Client Component that renders the Link's `<a>` tag."),"__NEXT_ERROR_CODE",{value:"E863",enumerable:!1,configurable:!0});s=a.default.Children.only(n)}let K=x?s&&"object"==typeof s&&s.ref:j,q=a.default.useCallback(e=>(null!==U&&(v.current=(0,f.mountLinkInstance)(e,L,U,N,R,b)),()=>{v.current&&((0,f.unmountLinkForCurrentNavigation)(v.current),v.current=null),(0,f.unmountPrefetchableInstance)(e)}),[R,L,U,N,b]),W={ref:(0,c.useMergedRef)(q,K),onClick(t){x||"function"!=typeof I||I(t),x&&s.props&&"function"==typeof s.props.onClick&&s.props.onClick(t),!U||t.defaultPrevented||function(t,r,n,s,i,o,l){if("u">typeof window){let u,{nodeName:c}=t.currentTarget;if("A"===c.toUpperCase()&&((u=t.currentTarget.getAttribute("target"))&&"_self"!==u||t.metaKey||t.ctrlKey||t.shiftKey||t.altKey||t.nativeEvent&&2===t.nativeEvent.which)||t.currentTarget.hasAttribute("download"))return;if(!(0,p.isLocalURL)(r)){i&&(t.preventDefault(),location.replace(r));return}if(t.preventDefault(),l){let e=!1;if(l({preventDefault:()=>{e=!0}}),e)return}let{dispatchNavigateAction:h}=e.r(99781);a.default.startTransition(()=>{h(n||r,i?"replace":"push",o??!0,s.current)})}}(t,L,F,v,O,A,P)},onMouseEnter(e){x||"function"!=typeof C||C(e),x&&s.props&&"function"==typeof s.props.onMouseEnter&&s.props.onMouseEnter(e),U&&R&&(0,f.onNavigationIntent)(e.currentTarget,!0===$)},onTouchStart:function(e){x||"function"!=typeof M||M(e),x&&s.props&&"function"==typeof s.props.onTouchStart&&s.props.onTouchStart(e),U&&R&&(0,f.onNavigationIntent)(e.currentTarget,!0===$)}};return(0,h.isAbsoluteUrl)(F)?W.href=F:x&&!k&&("a"!==s.type||"href"in s.props)||(W.href=(0,d.addBasePath)(F)),i=x?a.default.cloneElement(s,W):(0,o.jsx)("a",{...D,...W,children:n}),(0,o.jsx)(m.Provider,{value:l,children:i})}e.r(84508);let m=(0,a.createContext)(f.IDLE_LINK_STATUS),v=()=>(0,a.useContext)(m);("function"==typeof r.default||"object"==typeof r.default&&null!==r.default)&&void 0===r.default.__esModule&&(Object.defineProperty(r.default,"__esModule",{value:!0}),Object.assign(r.default,r),t.exports=r.default)},18566,(e,t,r)=>{t.exports=e.r(76562)},25045,e=>{"use strict";var t=e.i(43476),r=e.i(22016),n=e.i(18566),s=e.i(8896);function i({children:e}){let i=(0,n.usePathname)(),o=s.db.useUser();return(0,t.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,t.jsx)("header",{className:"sticky top-0 z-10 border-b border-[var(--border)] bg-[var(--bg)]",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto px-4 h-12 flex items-center justify-between",children:[(0,t.jsxs)("nav",{className:"flex items-center gap-6",children:[(0,t.jsx)(r.default,{href:"/",className:`text-sm font-medium ${"/"===i?"text-[var(--accent)]":"text-[var(--muted)] hover:text-[var(--text)]"}`,children:"Create"}),(0,t.jsx)(r.default,{href:"/gallery",className:`text-sm font-medium ${"/gallery"===i?"text-[var(--accent)]":"text-[var(--muted)] hover:text-[var(--text)]"}`,children:"Gallery"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"text-xs text-[var(--muted)] truncate max-w-[160px]",title:o?.email??"",children:o?.email??""}),(0,t.jsx)("button",{type:"button",onClick:()=>s.db.auth.signOut(),className:"text-xs text-[var(--muted)] hover:text-[var(--text)]",children:"Sign out"})]})]})}),(0,t.jsx)("main",{className:"flex-1",children:e})]})}e.s(["AppShell",()=>i])}]);